var e=require("@gltf-transform/core"),t=require("ndarray-pixels"),r=require("@gltf-transform/extensions"),n=require("ktx-parse"),o=require("ndarray"),s=require("ndarray-lanczos");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=/*#__PURE__*/i(o);const c=function(e,r,n){try{if(!e)return Promise.resolve(null);const o=e.getImage();return o?Promise.resolve(t.getPixels(o,e.getMimeType())).then(function(e){for(let t=0;t<e.shape[0];++t)for(let r=0;r<e.shape[1];++r)n(e,t,r);return Promise.resolve(t.savePixels(e,"image/png")).then(function(e){return r.setImage(e).setMimeType("image/png")})}):Promise.resolve(null)}catch(e){return Promise.reject(e)}};function l(e,t){return Object.defineProperty(t,"name",{value:e}),t}function u(e,t,r){return!!e&&e.stack.lastIndexOf(t)<e.stack.lastIndexOf(r)}function f(t){const r=t.getIndices(),n=t.getAttribute("POSITION");switch(t.getMode()){case e.Primitive.Mode.POINTS:return n.getCount();case e.Primitive.Mode.LINES:return r?r.getCount()/2:n.getCount()/2;case e.Primitive.Mode.LINE_LOOP:return n.getCount();case e.Primitive.Mode.LINE_STRIP:return n.getCount()-1;case e.Primitive.Mode.TRIANGLES:return r?r.getCount()/3:n.getCount()/3;case e.Primitive.Mode.TRIANGLE_STRIP:case e.Primitive.Mode.TRIANGLE_FAN:return n.getCount()-2;default:throw new Error("Unexpected mode: "+t.getMode())}}class g{constructor(){this._map=new Map}get size(){return this._map.size}has(e){return this._map.has(e)}add(e,t){let r=this._map.get(e);return r||(r=new Set,this._map.set(e,r)),r.add(t),this}get(e){return this._map.get(e)||new Set}keys(){return this._map.keys()}}function p(e,t){if(void 0===t&&(t=2),0===e)return"0 Bytes";const r=t<0?0:t,n=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,n)).toFixed(r))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}function m(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function h(e,t){return`${m(e)} → ${m(t)} (${function(e,t,r){return void 0===r&&(r=2),(e>t?"–":"+")+(Math.abs(e-t)/e*100).toFixed(r)+"%"}(e,t)})`}function d(e){const t=[];for(const r of e.listAttributes())t.push(r);for(const r of e.listTargets())for(const e of r.listAttributes())t.push(e);return Array.from(new Set(t))}function y(e,t,r){e.swap(t,r);for(const n of e.listTargets())n.swap(t,r)}function T(e,t){if(null==e&&null==t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function A(e,t,r){const n=e.getElementSize(),o=e.getCount(),s=e.getArray(),i=s.slice(0,r*n);for(let e=0;e<o;e++)for(let r=0;r<n;r++)i[t[e]*n+r]=s[e*n+r];e.setArray(i)}function E(e,t){void 0===t&&(t=e);const r=t<=65534?new Uint16Array(e):new Uint32Array(e);for(let e=0;e<r.length;e++)r[e]=e;return r}function S(t){const r=e.Document.fromGraph(t.getGraph()),n=t.getMaterial();return`${r.getRoot().listMaterials().indexOf(n)}|${t.getMode()}|${!!t.getIndices()}|${t.listSemantics().sort().map(e=>{const r=t.getAttribute(e);return`${e}:${r.getElementSize()}:${r.getComponentType()}`}).join("+")}|${t.listTargets().map(e=>e.listSemantics().sort().map(e=>{const r=t.getAttribute(e);return`${e}:${r.getElementSize()}:${r.getComponentType()}`}).join("+")).join("~")}`}function P(e,t){const[r,n]=t,[o,s]=e;if(o<=r&&s<=n)return e;let i=o,a=s;return i>r&&(a=Math.floor(a*(r/i)),i=r),a>n&&(i=Math.floor(i*(n/a)),a=n),[i,a]}const M="center",I={pivot:"center"};function v(t){const r=new Set;let n,o=t;for(;n=o.getParentNode();){if(r.has(n))throw new Error("Circular dependency in scene graph.");r.add(n),o=n}return o.listParents().filter(t=>t instanceof e.Scene)}function b(e){const t=v(e),r=e.getParentNode();if(!r)return e;e.setMatrix(e.getWorldMatrix()),r.removeChild(e);for(const r of t)r.addChild(e);return e}var N="undefined"!=typeof Float32Array?Float32Array:Array;function x(e,t){var r=t[0],n=t[1],o=t[2],s=t[3],i=t[4],a=t[5],c=t[6],l=t[7],u=t[8],f=t[9],g=t[10],p=t[11],m=t[12],h=t[13],d=t[14],y=t[15],T=r*a-n*i,A=r*c-o*i,E=r*l-s*i,S=n*c-o*a,P=n*l-s*a,M=o*l-s*c,I=u*h-f*m,v=u*d-g*m,b=u*y-p*m,N=f*d-g*h,x=f*y-p*h,R=g*y-p*d,C=T*R-A*x+E*N+S*b-P*v+M*I;return C?(e[0]=(a*R-c*x+l*N)*(C=1/C),e[1]=(o*x-n*R-s*N)*C,e[2]=(h*M-d*P+y*S)*C,e[3]=(g*P-f*M-p*S)*C,e[4]=(c*b-i*R-l*v)*C,e[5]=(r*R-o*b+s*v)*C,e[6]=(d*E-m*M-y*A)*C,e[7]=(u*M-g*E+p*A)*C,e[8]=(i*x-a*b+l*I)*C,e[9]=(n*b-r*x-s*I)*C,e[10]=(m*P-h*E+y*T)*C,e[11]=(f*E-u*P-p*T)*C,e[12]=(a*v-i*N-c*I)*C,e[13]=(r*N-n*v+o*I)*C,e[14]=(h*A-m*S-d*T)*C,e[15]=(u*S-f*A+g*T)*C,e):null}function R(e,t,r){var n=t[0],o=t[1],s=t[2],i=t[3],a=t[4],c=t[5],l=t[6],u=t[7],f=t[8],g=t[9],p=t[10],m=t[11],h=t[12],d=t[13],y=t[14],T=t[15],A=r[0],E=r[1],S=r[2],P=r[3];return e[0]=A*n+E*a+S*f+P*h,e[1]=A*o+E*c+S*g+P*d,e[2]=A*s+E*l+S*p+P*y,e[3]=A*i+E*u+S*m+P*T,e[4]=(A=r[4])*n+(E=r[5])*a+(S=r[6])*f+(P=r[7])*h,e[5]=A*o+E*c+S*g+P*d,e[6]=A*s+E*l+S*p+P*y,e[7]=A*i+E*u+S*m+P*T,e[8]=(A=r[8])*n+(E=r[9])*a+(S=r[10])*f+(P=r[11])*h,e[9]=A*o+E*c+S*g+P*d,e[10]=A*s+E*l+S*p+P*y,e[11]=A*i+E*u+S*m+P*T,e[12]=(A=r[12])*n+(E=r[13])*a+(S=r[14])*f+(P=r[15])*h,e[13]=A*o+E*c+S*g+P*d,e[14]=A*s+E*l+S*p+P*y,e[15]=A*i+E*u+S*m+P*T,e}function C(){var e=new N(3);return N!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function w(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e}function O(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e}function $(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function L(e,t){var r=t[0],n=t[1],o=t[2],s=r*r+n*n+o*o;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function z(e,t,r){var n=t[0],o=t[1],s=t[2],i=r[3]*n+r[7]*o+r[11]*s+r[15];return e[0]=(r[0]*n+r[4]*o+r[8]*s+r[12])/(i=i||1),e[1]=(r[1]*n+r[5]*o+r[9]*s+r[13])/i,e[2]=(r[2]*n+r[6]*o+r[10]*s+r[14])/i,e}function F(e,t,r){var n=t[0],o=t[1],s=t[2];return e[0]=n*r[0]+o*r[3]+s*r[6],e[1]=n*r[1]+o*r[4]+s*r[7],e[2]=n*r[2]+o*r[5]+s*r[8],e}function U(){var e=new N(4);return N!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),C();var _=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e},k=function(e){return Math.hypot(e[0],e[1],e[2],e[3])};U();const G="dedup",q={keepUniqueNames:!1,propertyTypes:[e.PropertyType.ACCESSOR,e.PropertyType.MESH,e.PropertyType.TEXTURE,e.PropertyType.MATERIAL,e.PropertyType.SKIN]};function B(t){void 0===t&&(t=q);const r={...q,...t},n=new Set(r.propertyTypes);for(const e of r.propertyTypes)if(!q.propertyTypes.includes(e))throw new Error(`${G}: Unsupported deduplication on type "${e}".`);return l(G,t=>{const o=t.getLogger();n.has(e.PropertyType.ACCESSOR)&&function(t){const r=t.getLogger(),n=new Map,o=new Map,s=new Map,i=new Map,a=t.getRoot().listMeshes();a.forEach(e=>{e.listPrimitives().forEach(e=>{e.listAttributes().forEach(e=>c(e,o)),c(e.getIndices(),n)})});for(const e of t.getRoot().listAnimations())for(const t of e.listSamplers())c(t.getInput(),s),c(t.getOutput(),i);function c(e,t){if(!e)return;const r=[e.getCount(),e.getType(),e.getComponentType(),e.getNormalized(),e.getSparse()].join(":");let n=t.get(r);n||t.set(r,n=new Set),n.add(e)}function l(t,r){for(let n=0;n<t.length;n++){const o=t[n],s=e.BufferUtils.toView(o.getArray());if(!r.has(o))for(let i=n+1;i<t.length;i++){const n=t[i];r.has(n)||e.BufferUtils.equals(s,e.BufferUtils.toView(n.getArray()))&&r.set(n,o)}}}let u=0;const f=new Map;for(const e of[o,n,s,i])for(const t of e.values())u+=t.size,l(Array.from(t),f);r.debug(`${G}: Merged ${f.size} of ${u} accessors.`),a.forEach(e=>{e.listPrimitives().forEach(e=>{e.listAttributes().forEach(t=>{f.has(t)&&e.swap(t,f.get(t))});const t=e.getIndices();t&&f.has(t)&&e.swap(t,f.get(t))})});for(const e of t.getRoot().listAnimations())for(const t of e.listSamplers()){const e=t.getInput(),r=t.getOutput();e&&f.has(e)&&t.swap(e,f.get(e)),r&&f.has(r)&&t.swap(r,f.get(r))}Array.from(f.keys()).forEach(e=>e.dispose())}(t),n.has(e.PropertyType.TEXTURE)&&function(t,r){const n=t.getLogger(),o=t.getRoot(),s=o.listTextures(),i=new Map;for(let t=0;t<s.length;t++){const n=s[t],o=n.getImage();if(!i.has(n))for(let a=t+1;a<s.length;a++){const t=s[a],c=t.getImage();if(i.has(t))continue;if(n.getMimeType()!==t.getMimeType())continue;if(r.keepUniqueNames&&n.getName()!==t.getName())continue;const l=n.getSize(),u=t.getSize();l&&u&&l[0]===u[0]&&l[1]===u[1]&&o&&c&&e.BufferUtils.equals(o,c)&&i.set(t,n)}}n.debug(`${G}: Merged ${i.size} of ${o.listTextures().length} textures.`),Array.from(i.entries()).forEach(t=>{let[r,n]=t;r.listParents().forEach(t=>{t instanceof e.Root||t.swap(r,n)}),r.dispose()})}(t,r),n.has(e.PropertyType.MATERIAL)&&function(t,r){const n=t.getLogger(),o=t.getRoot().listMaterials(),s=new Map,i=new Map,a=new Set;r.keepUniqueNames||a.add("name");for(let e=0;e<o.length;e++){const t=o[e];if(!s.has(t)&&!j(t,i))for(let r=e+1;r<o.length;r++){const e=o[r];s.has(e)||j(e,i)||t.equals(e,a)&&s.set(e,t)}}n.debug(`${G}: Merged ${s.size} of ${o.length} materials.`),Array.from(s.entries()).forEach(t=>{let[r,n]=t;r.listParents().forEach(t=>{t instanceof e.Root||t.swap(r,n)}),r.dispose()})}(t,r),n.has(e.PropertyType.MESH)&&function(t,r){const n=t.getLogger(),o=t.getRoot(),s=new Map;o.listAccessors().forEach((e,t)=>s.set(e,t)),o.listMaterials().forEach((e,t)=>s.set(e,t));const i=o.listMeshes().length,a=new Map;for(const t of o.listMeshes()){const n=[];for(const e of t.listPrimitives())n.push(D(e,s));let o="";if(r.keepUniqueNames&&(o+=t.getName()+";"),o+=n.join(";"),a.has(o)){const r=a.get(o);t.listParents().forEach(n=>{n.propertyType!==e.PropertyType.ROOT&&n.swap(t,r)}),t.dispose()}else a.set(o,t)}n.debug(`${G}: Merged ${i-a.size} of ${i} meshes.`)}(t,r),n.has(e.PropertyType.SKIN)&&function(t,r){const n=t.getLogger(),o=t.getRoot().listSkins(),s=new Map,i=new Set(["joints"]);r.keepUniqueNames||i.add("name");for(let e=0;e<o.length;e++){const t=o[e];if(!s.has(t))for(let r=e+1;r<o.length;r++){const e=o[r];s.has(e)||t.equals(e,i)&&T(t.listJoints(),e.listJoints())&&s.set(e,t)}}n.debug(`${G}: Merged ${s.size} of ${o.length} skins.`),Array.from(s.entries()).forEach(t=>{let[r,n]=t;r.listParents().forEach(t=>{t instanceof e.Root||t.swap(r,n)}),r.dispose()})}(t,r),o.debug(`${G}: Complete.`)})}function D(t,r){const n=[];for(const e of t.listSemantics()){const o=t.getAttribute(e);n.push(e+":"+r.get(o))}if(t instanceof e.Primitive){const e=t.getIndices();e&&n.push("indices:"+r.get(e));const o=t.getMaterial();o&&n.push("material:"+r.get(o)),n.push("mode:"+t.getMode());for(const e of t.listTargets())n.push("target:"+D(e,r))}return n.join(",")}function j(e,t){if(t.has(e))return t.get(e);const r=e.getGraph(),n=new Set,o=r.listParentEdges(e);for(;o.length>0;){const s=o.pop();if(!0===s.getAttributes().modifyChild)return t.set(e,!0),!0;const i=s.getChild();if(!n.has(i))for(const e of r.listChildEdges(i))o.push(e)}return t.set(e,!1),!1}const H=/color|emissive|diffuse/i;function W(e){return e.getGraph().listParentEdges(e).some(e=>e.getAttributes().isColor||H.test(e.getName()))?"srgb":null}function X(t){const r=t.getGraph(),n=new Set,o=new Set;return function t(s){const i=new Set;for(const t of r.listChildEdges(s))t.getChild()instanceof e.Texture&&i.add(t.getName()+"Info");for(const a of r.listChildEdges(s)){const r=a.getChild();n.has(r)||(n.add(r),r instanceof e.TextureInfo&&i.has(a.getName())?o.add(r):r instanceof e.ExtensionProperty&&t(r))}}(t),Array.from(o)}function K(t){const r=e.Document.fromGraph(t.getGraph()).getRoot(),n=t.getGraph().listParentEdges(t).filter(e=>e.getParent()!==r).map(e=>e.getName());return Array.from(new Set(n))}const V=function(r,n){try{const o=r.getRoot(),s=r.getGraph(),i=r.getLogger(),a=o.listTextures().map(function(r){return Promise.resolve(function(e){return Promise.resolve(function(e){return Promise.resolve(function(r,n){try{var o=Promise.resolve(t.getPixels(e.getImage(),e.getMimeType()))}catch(e){return null}return o&&o.then?o.then(void 0,function(){return null}):o}())}(e)).then(function(e){if(!e)return null;const t=[Infinity,Infinity,Infinity,Infinity],r=[-Infinity,-Infinity,-Infinity,-Infinity],n=[0,0,0,0],[o,s]=e.shape;for(let i=0;i<o;i++){for(let n=0;n<s;n++)for(let o=0;o<4;o++)t[o]=Math.min(t[o],e.get(i,n,o)),r[o]=Math.max(r[o],e.get(i,n,o));if(k(_(n,r,t))/255>Z)return null}return function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e}(n,((i=n)[0]=(a=r)[0]+(c=t)[0],i[1]=a[1]+c[1],i[2]=a[2]+c[2],i[3]=a[3]+c[3],i),.5/255);var i,a,c})}(r)).then(function(t){var a;if(!t)return;"srgb"===W(r)&&e.ColorUtils.convertSRGBToLinear(t,t);const c=r.getName()||r.getURI(),l=null==(a=r.getSize())?void 0:a.join("x"),u=K(r);for(const e of s.listParentEdges(r)){const r=e.getParent();r!==o&&le(r,t,e.getName(),i)&&e.dispose()}1===r.listParents().length&&(n.dispose(r),i.debug(`${J}: Removed solid-color texture "${c}" (${l}px ${u.join(", ")})`))})});return Promise.resolve(Promise.all(a)).then(function(){})}catch(e){return Promise.reject(e)}},J="prune",Z=3/255,Q={propertyTypes:[e.PropertyType.NODE,e.PropertyType.SKIN,e.PropertyType.MESH,e.PropertyType.CAMERA,e.PropertyType.PRIMITIVE,e.PropertyType.PRIMITIVE_TARGET,e.PropertyType.ANIMATION,e.PropertyType.MATERIAL,e.PropertyType.TEXTURE,e.PropertyType.ACCESSOR,e.PropertyType.BUFFER],keepLeaves:!1,keepAttributes:!0,keepIndices:!0,keepSolidTextures:!0};function Y(t){void 0===t&&(t=Q);const r={...Q,...t},n=new Set(r.propertyTypes);return l(J,function(t){try{function o(){if(n.has(e.PropertyType.ACCESSOR)&&i.listAccessors().forEach(e=>te(e,c)),n.has(e.PropertyType.BUFFER)&&i.listBuffers().forEach(e=>te(e,c)),c.empty())s.info(`${J}: No unused properties found.`);else{const e=c.entries().map(e=>{let[t,r]=e;return`${t} (${r})`}).join(", ");s.info(`${J}: Removed types... ${e}`)}s.debug(`${J}: Complete.`)}const s=t.getLogger(),i=t.getRoot(),a=t.getGraph(),c=new ee;if(n.has(e.PropertyType.MESH))for(const u of i.listMeshes())u.listPrimitives().length>0||c.dispose(u);if(n.has(e.PropertyType.NODE)){if(!r.keepLeaves)for(const f of i.listScenes())ne(a,f,c);for(const g of i.listNodes())te(g,c)}if(n.has(e.PropertyType.SKIN))for(const p of i.listSkins())te(p,c);if(n.has(e.PropertyType.MESH))for(const m of i.listMeshes())te(m,c);if(n.has(e.PropertyType.CAMERA))for(const h of i.listCameras())te(h,c);if(n.has(e.PropertyType.PRIMITIVE)&&re(a,e.PropertyType.PRIMITIVE,c),n.has(e.PropertyType.PRIMITIVE_TARGET)&&re(a,e.PropertyType.PRIMITIVE_TARGET,c),!r.keepAttributes&&n.has(e.PropertyType.ACCESSOR)){const d=new Map;for(const y of i.listMeshes())for(const T of y.listPrimitives()){const A=T.getMaterial(),E=ie(T,ae(t,A));oe(T,E),T.listTargets().forEach(e=>oe(e,E)),A&&(d.has(A)?d.get(A).add(T):d.set(A,new Set([T])))}for(const[S,P]of d)ce(S,Array.from(P))}if(!r.keepIndices&&n.has(e.PropertyType.ACCESSOR))for(const M of i.listMeshes())for(const I of M.listPrimitives())se(I);if(n.has(e.PropertyType.ANIMATION))for(const v of i.listAnimations()){for(const b of v.listChannels())b.getTargetNode()||c.dispose(b);if(v.listChannels().length)v.listSamplers().forEach(e=>te(e,c));else{const N=v.listSamplers();te(v,c),N.forEach(e=>te(e,c))}}n.has(e.PropertyType.MATERIAL)&&i.listMaterials().forEach(e=>te(e,c));const l=function(){if(n.has(e.PropertyType.TEXTURE)){i.listTextures().forEach(e=>te(e,c));const e=function(){if(!r.keepSolidTextures)return Promise.resolve(V(t,c)).then(function(){})}();if(e&&e.then)return e.then(function(){})}}();return Promise.resolve(l&&l.then?l.then(o):o())}catch(x){return Promise.reject(x)}})}class ee{constructor(){this.disposed={}}empty(){for(const e in this.disposed)return!1;return!0}entries(){return Object.entries(this.disposed)}dispose(e){this.disposed[e.propertyType]=this.disposed[e.propertyType]||0,this.disposed[e.propertyType]++,e.dispose()}}function te(t,r){t.listParents().filter(t=>!(t instanceof e.Root||t instanceof e.AnimationChannel)).length||r.dispose(t)}function re(e,t,r){for(const n of e.listEdges()){const e=n.getParent();e.propertyType===t&&te(e,r)}}function ne(t,r,n){if(r.listChildren().forEach(e=>ne(t,e,n)),r instanceof e.Scene)return;const o=t.listParentEdges(r).some(t=>{const r=t.getParent().propertyType;return r!==e.PropertyType.ROOT&&r!==e.PropertyType.SCENE&&r!==e.PropertyType.NODE});0===t.listChildren(r).length&&!o&&n.dispose(r)}function oe(e,t){for(const r of t)e.setAttribute(r,null)}function se(e){const t=e.getIndices(),r=e.listAttributes()[0];t&&r&&t.getCount()===r.getCount()&&e.setIndices(null)}function ie(e,t){const r=[];for(const n of e.listSemantics())"TANGENT"!==n||t.has(n)?(n.startsWith("TEXCOORD_")&&!t.has(n)||n.startsWith("COLOR_")&&"COLOR_0"!==n)&&r.push(n):r.push(n);return r}function ae(t,r,n){if(void 0===n&&(n=new Set),!r)return n;const o=t.getGraph().listChildEdges(r),s=new Set;for(const t of o)t.getChild()instanceof e.Texture&&s.add(t.getName());for(const r of o){const o=r.getName(),i=r.getChild();i instanceof e.TextureInfo&&s.has(o.replace(/Info$/,""))&&n.add(`TEXCOORD_${i.getTexCoord()}`),i instanceof e.Texture&&o.match(/normalTexture/i)&&n.add("TANGENT"),i instanceof e.ExtensionProperty&&ae(t,i,n)}return n}function ce(e,t){const r=X(e),n=new Set(r.map(e=>e.getTexCoord())),o=Array.from(n).sort(),s=new Map(o.map((e,t)=>[e,t])),i=new Map(o.map((e,t)=>[`TEXCOORD_${e}`,`TEXCOORD_${t}`]));for(const e of r){const t=e.getTexCoord();e.setTexCoord(s.get(t))}for(const e of t){const t=e.listSemantics().filter(e=>e.startsWith("TEXCOORD_")).sort();a(e,t),e.listTargets().forEach(e=>a(e,t))}function a(e,t){for(const r of t){const t=e.getAttribute(r);if(!t)continue;const n=i.get(r);n!==r&&(e.setAttribute(n,t),e.setAttribute(r,null))}}}function le(t,r,n,o){if(t instanceof e.Material)switch(n){case"baseColorTexture":return t.setBaseColorFactor((s=r,i=r,a=t.getBaseColorFactor(),s[0]=i[0]*a[0],s[1]=i[1]*a[1],s[2]=i[2]*a[2],s[3]=i[3]*a[3],s)),!0;case"emissiveTexture":return t.setEmissiveFactor(function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}([0,0,0],r.slice(0,3),t.getEmissiveFactor())),!0;case"occlusionTexture":return Math.abs(r[0]-1)<=Z;case"metallicRoughnessTexture":return t.setRoughnessFactor(r[1]*t.getRoughnessFactor()),t.setMetallicFactor(r[2]*t.getMetallicFactor()),!0;case"normalTexture":return k(_(U(),r,[.5,.5,1,1]))<=Z}var s,i,a;return o.warn(`${J}: Detected single-color ${n} texture. Pruning ${n} not yet supported.`),!1}const ue="weld",fe={DEFAULT:1e-4,TEXCOORD:1e-4,COLOR:.01,NORMAL:.05,JOINTS:0,WEIGHTS:.01},ge={tolerance:fe.DEFAULT,toleranceNormal:fe.NORMAL,overwrite:!0,exhaustive:!1};function pe(t){void 0===t&&(t=ge);const r=Me(t);return l(ue,function(t){try{function n(){return Promise.resolve(t.transform(B({propertyTypes:[e.PropertyType.ACCESSOR]}))).then(function(){o.debug(`${ue}: Complete.`)})}const o=t.getLogger();for(const i of t.getRoot().listMeshes()){for(const a of i.listPrimitives())me(t,a,r),Ie(a)&&a.dispose();0===i.listPrimitives().length&&i.dispose()}const s=function(){if(r.tolerance>0)return Promise.resolve(t.transform(Y({propertyTypes:[e.PropertyType.ACCESSOR,e.PropertyType.NODE],keepAttributes:!0,keepIndices:!0,keepLeaves:!1}))).then(function(){})}();return Promise.resolve(s&&s.then?s.then(n):n())}catch(c){return Promise.reject(c)}})}function me(t,r,n){let o,s,i;if(void 0===r&&(r=ge),void 0===n&&(n=ge),t instanceof e.Primitive){const n=t.getGraph();o=e.Document.fromGraph(n),s=t,i=Me(r)}else o=t,s=r,i=Me(n);s.getIndices()&&!i.overwrite||s.getMode()!==e.Primitive.Mode.POINTS&&(0===i.tolerance?function(t,r){if(r.getIndices())return;const n=r.listAttributes()[0],o=n.getCount(),s=n.getBuffer(),i=t.createAccessor().setBuffer(s).setType(e.Accessor.Type.SCALAR).setArray(E(o));r.setIndices(i)}(o,s):function(e,t,r){const n=e.getLogger(),o=t.getAttribute("POSITION"),s=t.getIndices()||e.createAccessor().setArray(E(o.getCount())),i=new Uint32Array(new Set(s.getArray())).sort(),a={};for(const e of t.listSemantics()){const n=t.getAttribute(e);a[e]=Te(e,n,r)}var c;n.debug(`${ue}: Tolerance thresholds: ${c=a,Object.entries(c).map(e=>{let[t,r]=e;return`${t}=${r}`}).join(", ")}`);const l=[0,0,0],u=[0,0,0],f={},g=a.POSITION;for(let e=0;e<i.length;e++){o.getElement(i[e],l);const t=Pe(l,g);f[t]=f[t]||[],f[t].push(i[e])}const p=E(i[i.length-1]+1),m=new Array(i.length).fill(-1),d=o.getCount();let y=0;for(let e=0;e<i.length;e++){const n=i[e];o.getElement(n,l);const s=r.exhaustive?Se(l,g):[Pe(l,g)];e:for(const e of s)if(f[e])t:for(const r of f[e]){const e=p[r];if(n<=e)continue t;o.getElement(e,u);const s=t.listSemantics().every(r=>Ae(t.getAttribute(r),n,e,a[r])),i=t.listTargets().every(t=>t.listSemantics().every(r=>Ae(t.getAttribute(r),n,e,a[r])));if(s&&i){p[n]=e;break e}}m[n]=p[n]===n?y++:m[p[n]]}n.debug(`${ue}: ${h(d,y)} vertices.`);const T=s.getCount(),A=E(T,i.length);for(let e=0;e<T;e++)A[e]=m[s.getScalar(e)];t.setIndices(s.clone().setArray(A)),1===s.listParents().length&&s.dispose();for(const e of t.listAttributes())he(t,e,m,y);for(const e of t.listTargets())for(const t of e.listAttributes())he(e,t,m,y);!function(e){const t=e.getIndices();if(!t)return;const r=[];let n=-Infinity;for(let e=0,o=t.getCount();e<o;e+=3){const o=t.getScalar(e),s=t.getScalar(e+1),i=t.getScalar(e+2);o!==s&&o!==i&&s!==i&&(r.push(o,s,i),n=Math.max(n,o,s,i))}const o=E(r.length,n);o.set(r),t.setArray(o)}(t)}(o,s,i))}function he(e,t,r,n){const o=(a=t.getArray(),c=n*t.getElementSize(),new(0,a.constructor)(c)),s=t.clone().setArray(o),i=new Uint8Array(n);var a,c;for(let e=0,n=[];e<r.length;e++)i[r[e]]||(s.setElement(r[e],t.getElement(e,n)),i[r[e]]=1);e.swap(t,s),1===t.listParents().length&&t.dispose()}const de=[],ye=[];function Te(e,t,r){if("NORMAL"===e||"TANGENT"===e)return r.toleranceNormal;if(e.startsWith("COLOR_"))return fe.COLOR;if(e.startsWith("TEXCOORD_"))return fe.TEXCOORD;if(e.startsWith("JOINTS_"))return fe.JOINTS;if(e.startsWith("WEIGHTS_"))return fe.WEIGHTS;de.length=ye.length=0,t.getMinNormalized(de),t.getMaxNormalized(ye);const n=ye.map((e,t)=>e-de[t]),o=Math.max(...n);return r.tolerance*o}function Ae(e,t,r,n,o){e.getElement(t,de),e.getElement(r,ye);for(let t=0,r=e.getElementSize();t<r;t++)if(Math.abs(de[t]-ye[t])>n)return!1;return!0}const Ee=[0,-1,1];function Se(e,t){const r=[],n=[0,0,0];for(const o of Ee)for(const s of Ee)for(const i of Ee)n[0]=e[0]+o*t,n[1]=e[1]+s*t,n[2]=e[2]+i*t,r.push(Pe(n,t));return r}function Pe(e,t){return Math.round(e[0]/t)+":"+Math.round(e[1]/t)+":"+Math.round(e[2]/t)}function Me(e){const t={...ge,...e};if(t.tolerance<0||t.tolerance>.1)throw new Error(`${ue}: Requires 0 <= tolerance <= 0.1`);if(t.toleranceNormal<0||t.toleranceNormal>Math.PI/2)throw new Error(`${ue}: Requires 0 <= toleranceNormal <= ${(Math.PI/2).toFixed(2)}`);return t.tolerance>0&&(t.tolerance=Math.max(t.tolerance,Number.EPSILON),t.toleranceNormal=Math.max(t.toleranceNormal,Number.EPSILON)),t}function Ie(e){const t=e.getIndices();return!!t&&0===t.getCount()}function ve(t,r,n){var o;void 0===n&&(n=new Set);const s=t.getAttribute("POSITION"),i=(null==(o=t.getIndices())?void 0:o.getArray())||E(s.getCount());s&&be(r,s,i,new Set(n));const a=t.getAttribute("NORMAL");a&&Ne(r,a,i,new Set(n));const c=t.getAttribute("TANGENT");c&&xe(r,c,i,new Set(n));for(const e of t.listTargets()){const t=e.getAttribute("POSITION");t&&be(r,t,i,new Set(n));const o=e.getAttribute("NORMAL");o&&Ne(r,o,i,new Set(n));const s=e.getAttribute("TANGENT");s&&xe(r,s,i,new Set(n))}var l,u,f,g,p,m,h,d,y,T,A,S,P,M,I,v,b;((u=(l=r)[0])*(h=l[5])-(f=l[1])*(m=l[4]))*((S=l[10])*(b=l[15])-(P=l[11])*(v=l[14]))-(u*(d=l[6])-(g=l[2])*m)*((A=l[9])*b-P*(I=l[13]))+(u*(y=l[7])-(p=l[3])*m)*(A*v-S*I)+(f*d-g*h)*((T=l[8])*b-P*(M=l[12]))-(f*y-p*h)*(T*v-S*M)+(g*y-p*d)*(T*I-A*M)<0&&function(t){if(t.getMode()!==e.Primitive.Mode.TRIANGLES)return;t.getIndices()||me(t,{tolerance:0});const r=t.getIndices();for(let e=0,t=r.getCount();e<t;e+=3){const t=r.getScalar(e),n=r.getScalar(e+2);r.setScalar(e,n),r.setScalar(e+2,t)}}(t);for(let e=0;e<i.length;e++)n.add(i[e])}function be(e,t,r,n){const o=new Float32Array(3*t.getCount()),s=t.getElementSize();for(let e=0,r=[],n=t.getCount();e<n;e++)o.set(t.getElement(e,r),e*s);const i=C();for(let s=0;s<r.length;s++){const a=r[s];n.has(a)||(t.getElement(a,i),z(i,i,e),o.set(i,3*a),n.add(a))}t.setArray(o).setNormalized(!1)}function Ne(e,t,r,n){const o=(s=new N(9),N!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s);var s;!function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10]}(o,e),function(e,t){var r=t[0],n=t[1],o=t[2],s=t[3],i=t[4],a=t[5],c=t[6],l=t[7],u=t[8],f=u*i-a*l,g=-u*s+a*c,p=l*s-i*c,m=r*f+n*g+o*p;m&&(e[0]=f*(m=1/m),e[1]=(-u*n+o*l)*m,e[2]=(a*n-o*i)*m,e[3]=g*m,e[4]=(u*r-o*c)*m,e[5]=(-a*r+o*s)*m,e[6]=p*m,e[7]=(-l*r+n*c)*m,e[8]=(i*r-n*s)*m)}(o,o),function(e,t){if(e===t){var r=t[1],n=t[2],o=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=n,e[7]=o}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}(o,o);const i=C();for(let e=0;e<r.length;e++){const s=r[e];n.has(s)||(t.getElement(s,i),F(i,i,o),L(i,i),t.setElement(s,i),n.add(s))}}function xe(e,t,r,n){const o=C(),s=U();for(let i=0;i<r.length;i++){const a=r[i];if(n.has(a))continue;t.getElement(a,s);const[c,l,u]=s;o[0]=e[0]*c+e[4]*l+e[8]*u,o[1]=e[1]*c+e[5]*l+e[9]*u,o[2]=e[2]*c+e[6]*l+e[10]*u,L(o,o),s[0]=o[0],s[1]=o[1],s[2]=o[2],t.setElement(a,s),n.add(a)}}function Re(t,r,n,o){void 0===n&&(n=!1);for(const r of t.listPrimitives())if(r.listParents().some(r=>r.propertyType===e.PropertyType.MESH&&r!==t)){const e=r.clone();t.swap(r,e);for(const t of e.listTargets()){const r=t.clone();e.swap(t,r)}}if(!n){const r=new Set([...t.listPrimitives(),...t.listPrimitives().flatMap(e=>e.listTargets())]),n=new Map;for(const o of t.listPrimitives())for(const t of d(o))t.listParents().some(t=>(t instanceof e.Primitive||t instanceof e.PrimitiveTarget)&&!r.has(t))&&!n.has(t)&&n.set(t,t.clone());for(const e of r)for(const[t,r]of n)e.swap(t,r)}const s=new Map;for(const e of t.listPrimitives()){const t=e.getAttribute("POSITION");let n;o?n=o:s.has(t)?n=s.get(t):s.set(t,n=new Set),ve(e,r,n)}}const Ce=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],we="dequantize",Oe={pattern:/^((?!JOINTS_).)*$/};function $e(e,t){for(const r of e.listSemantics())Le(r,e.getAttribute(r),t);for(const r of e.listTargets())for(const e of r.listSemantics())Le(e,r.getAttribute(e),t)}function Le(e,t,r){if(!t.getArray())return;if(!r.pattern.test(e))return;if(t.getComponentSize()>=4)return;const n=t.getArray(),o=new Float32Array(n.length);for(let e=0,r=t.getCount(),s=[];e<r;e++)s=t.getElement(e,s),t.setArray(o).setElement(e,s).setArray(n);t.setArray(o).setNormalized(!1)}const ze={method:"edgebreaker",encodeSpeed:5,decodeSpeed:5,quantizePosition:14,quantizeNormal:10,quantizeColor:8,quantizeTexcoord:12,quantizeGeneric:12,quantizationVolume:"mesh"},Fe="flatten";function Ue(t){return{properties:t.getRoot().listScenes().map(t=>{const r=t.listChildren()[0],n=e.getBounds(t);return{name:t.getName(),rootName:r?r.getName():"",bboxMin:je(n.min),bboxMax:je(n.max)}})}}function _e(t){return{properties:t.getRoot().listMeshes().map(t=>{const r=t.listParents().filter(t=>t.propertyType!==e.PropertyType.ROOT).length;let n=0,o=0;const s=new Set,i=new Set,a=new Set;t.listPrimitives().forEach(e=>{for(const t of e.listSemantics()){const r=e.getAttribute(t);s.add(t+":"+He(r)),a.add(r)}for(const t of e.listTargets())t.listAttributes().forEach(e=>a.add(e));const t=e.getIndices();t&&(i.add(He(t)),a.add(t)),o+=e.listAttributes()[0].getCount(),n+=f(e)});let c=0;Array.from(a).forEach(e=>c+=e.getArray().byteLength);const l=t.listPrimitives().map(e=>Be[e.getMode()]);return{name:t.getName(),mode:Array.from(new Set(l)),primitives:t.listPrimitives().length,glPrimitives:n,vertices:o,indices:Array.from(i).sort(),attributes:Array.from(s).sort(),instances:r,size:c}})}}function ke(t){const r=t.getRoot().listMaterials().map(r=>{const n=r.listParents().filter(t=>t.propertyType!==e.PropertyType.ROOT).length,o=new Set(r.listExtensions()),s=t.getGraph().listEdges().filter(t=>{const n=t.getChild(),s=t.getParent();return n instanceof e.Texture&&s===r||!!(n instanceof e.Texture&&s instanceof e.ExtensionProperty&&o.has(s))}).map(e=>e.getName());return{name:r.getName(),instances:n,textures:s,alphaMode:r.getAlphaMode(),doubleSided:r.getDoubleSided()}});return{properties:r}}function Ge(t){return{properties:t.getRoot().listTextures().map(r=>{const o=r.listParents().filter(t=>t.propertyType!==e.PropertyType.ROOT).length,s=t.getGraph().listParentEdges(r).filter(t=>t.getParent().propertyType!==e.PropertyType.ROOT).map(e=>e.getName()),i=e.ImageUtils.getSize(r.getImage(),r.getMimeType());let a="";if("image/ktx2"===r.getMimeType()){const e=n.read(r.getImage()).dataFormatDescriptor[0];e.colorModel===n.KHR_DF_MODEL_ETC1S?a="ETC1S":e.colorModel===n.KHR_DF_MODEL_UASTC&&(a="UASTC")}return{name:r.getName(),uri:r.getURI(),slots:Array.from(new Set(s)),instances:o,mimeType:r.getMimeType(),compression:a,resolution:i?i.join("x"):"",size:r.getImage().byteLength,gpuSize:e.ImageUtils.getVRAMByteLength(r.getImage(),r.getMimeType())}})}}function qe(e){return{properties:e.getRoot().listAnimations().map(e=>{let t=Infinity,r=-Infinity;e.listSamplers().forEach(e=>{const n=e.getInput();n&&(t=Math.min(t,n.getMin([])[0]),r=Math.max(r,n.getMax([])[0]))});let n=0,o=0;const s=new Set;return e.listSamplers().forEach(e=>{const t=e.getInput(),r=e.getOutput();t&&(o+=t.getCount(),s.add(t),r&&s.add(r))}),Array.from(s).forEach(e=>{n+=e.getArray().byteLength}),{name:e.getName(),channels:e.listChannels().length,samplers:e.listSamplers().length,duration:Math.round(1e3*(r-t))/1e3,keyframes:o,size:n}})}}const Be=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"],De={Float32Array:"f32",Uint32Array:"u32",Uint16Array:"u16",Uint8Array:"u8",Int32Array:"i32",Int16Array:"i16",Int8Array:"i8"};function je(e){for(let t=0;t<e.length;t++)e[t].toFixed&&(e[t]=Number(e[t].toFixed(5)));return e}function He(e){const t=e.getArray();return(De[t.constructor.name]||"?")+(e.getNormalized()?"_norm":"")}const We="instance",Xe={min:2};function Ke(e,t){let r,n=0;for(;r=e.pop();){if(r.listChildren().length||r.getCamera()||r.getMesh()||r.getSkin()||r.listExtensions().length)continue;const t=r.getParentNode();t&&e.push(t),r.dispose(),n++}t.debug(`${We}: Removed ${n} unused nodes.`)}function Ve(e){const t=e.getMaterial();return!(!t||!t.getExtension("KHR_materials_volume"))}function Je(t){const r=t.getWorldScale();return!e.MathUtils.eq(r,[1,1,1])}function Ze(e,t,r,n){const o=r.listPrimitives()[0].getAttribute("POSITION").getBuffer(),s=e.createAccessor().setType("VEC3").setArray(new Float32Array(3*n)).setBuffer(o),i=e.createAccessor().setType("VEC4").setArray(new Float32Array(4*n)).setBuffer(o),a=e.createAccessor().setType("VEC3").setArray(new Float32Array(3*n)).setBuffer(o);return t.createInstancedMesh().setAttribute("TRANSLATION",s).setAttribute("ROTATION",i).setAttribute("SCALE",a)}const Qe={skipValidation:!1};function Ye(t,r){void 0===r&&(r={}),r={...Qe,...r};const n=t[0],o=e.Document.fromGraph(n.getGraph());if(!r.skipValidation&&new Set(t.map(S)).size>1)throw new Error("Requires >=2 Primitives, sharing the same Material and Mode, with compatible vertex attributes and indices.");const s=[],i=[];let a=0,c=0;for(const e of t){const t=et(e),r=[];for(let e=0;e<t.length;e++){const n=t[e];void 0===r[n]&&(r[n]=a++),c++}s.push(new Uint32Array(r)),i.push(t)}const l=o.createPrimitive().setMode(n.getMode()).setMaterial(n.getMaterial());for(const t of n.listSemantics()){const r=n.getAttribute(t),s=e.ComponentTypeToTypedArray[r.getComponentType()],i=o.createAccessor().setType(r.getType()).setBuffer(r.getBuffer()).setNormalized(r.getNormalized()).setArray(new s(a*r.getElementSize()));l.setAttribute(t,i)}const u=(n.getIndices()?E(a):null)&&o.createAccessor().setBuffer(n.getIndices().getBuffer()).setArray(E(c,a));l.setIndices(u);let f=0;for(let e=0;e<s.length;e++){const r=t[e],n=s[e],o=i[e],a=f;let c=a;for(const e of l.listSemantics()){const t=r.getAttribute(e),s=l.getAttribute(e),i=[];c=a;for(let e=0;e<o.length;e++){const r=o[e];t.getElement(r,i),s.setElement(n[r],i),u&&u.setScalar(c++,n[r])}}f=c}return l}function et(e){const t=e.getIndices();return t?t.getArray():E(e.getAttribute("POSITION").getCount())}const tt="join",{ROOT:rt,NODE:nt,MESH:ot,PRIMITIVE:st,ACCESSOR:it}=e.PropertyType,at=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],ct={keepMeshes:!1,keepNamed:!1};function lt(t,r,n){const o=t.getLogger(),s={},i=r.listChildren();for(let t=0;t<i.length;t++){const r=i[t];if(r.listParents().some(t=>t instanceof e.AnimationChannel))continue;const o=r.getMesh();if(o&&!r.getExtension("EXT_mesh_gpu_instancing")&&!r.getSkin())for(const e of o.listPrimitives()){if(e.listTargets().length>0)continue;const i=e.getMaterial();if(i&&i.getExtension("KHR_materials_volume"))continue;gt(e);let a=S(e);const c=o.getName()||r.getName();(n.keepMeshes||n.keepNamed&&c)&&(a+=`|${t}`),a in s||(s[a]={prims:[],primMeshes:[],primNodes:[],dstNode:r,dstMesh:void 0});const l=s[a];l.prims.push(e),l.primNodes.push(r)}}const a=Object.values(s).filter(e=>{let{prims:t}=e;return t.length>1}),c=new Set(a.flatMap(e=>e.primNodes));for(const e of c){const t=e.getMesh(),r=t.listParents().some(t=>t.propertyType!==rt&&e!==t);r&&e.setMesh(t.clone())}for(const e of a){const{dstNode:t,primNodes:r}=e;e.dstMesh=t.getMesh(),e.primMeshes=r.map(e=>e.getMesh())}for(const t of a){const{prims:r,primNodes:n,primMeshes:s,dstNode:i,dstMesh:a}=t,c=i.getMatrix();for(let t=0;t<r.length;t++){const o=n[t];let a=r[t];s[t].removePrimitive(a),(a.listParents().some(t=>t.propertyType!==e.PropertyType.ROOT)||ft(a))&&(a=r[t]=ut(r[t])),o!==i&&(R(at,x(at,c),o.getMatrix()),ve(a,at))}const l=Ye(r),u=l.listAttributes()[0].getCount();a.addPrimitive(l),o.debug(`${tt}: Joined Primitives (${r.length}) containing ${m(u)} vertices under Node "${i.getName()}".`)}}function ut(e){const t=e.clone();for(const e of t.listSemantics())t.setAttribute(e,t.getAttribute(e).clone());const r=t.getIndices();return r&&t.setIndices(r.clone()),t}function ft(e){for(const t of e.listAttributes())for(const r of t.listParents())if(r!==e&&r.propertyType!==rt)return!0;return!1}function gt(e){for(const t of["POSITION","NORMAL","TANGENT"]){const r=e.getAttribute(t);r&&r.getComponentSize()<4&&Le(t,r,{pattern:/.*/})}}function pt(t){const r=e.Document.fromGraph(t.getGraph());let n=0;for(const o of r.getGraph().listParentEdges(t)){const t=o.getParent();let{channels:s}=o.getAttributes();s&&"baseColorTexture"===o.getName()&&t instanceof e.Material&&t.getAlphaMode()===e.Material.AlphaMode.OPAQUE&&(s&=~e.TextureChannel.A),s?n|=s:t.propertyType!==e.PropertyType.ROOT&&r.getLogger().warn(`Missing attribute ".channels" on edge, "${o.getName()}".`)}return n}const mt="reorder",ht={target:"size"};function dt(t){const r={...ht,...t},n=r.encoder;if(!n)throw new Error(`${mt}: encoder dependency required — install "meshoptimizer".`);return l(mt,function(t){try{const o=t.getLogger();return Promise.resolve(n.ready).then(function(){const s=function(e){const t=new g,r=new Map,n=new g;for(const o of e.getRoot().listMeshes())for(const e of o.listPrimitives()){const o=e.getIndices();if(o){r.set(o,e.getMode());for(const r of d(e))t.add(o,r),n.add(r,e)}}return{indicesToAttributes:t,indicesToMode:r,attributesToPrimitives:n}}(t);for(const t of s.indicesToAttributes.keys()){const o=t.clone();let i=o.getArray().slice();i instanceof Uint32Array||(i=new Uint32Array(i));const[a,c]=n.reorderMesh(i,s.indicesToMode.get(t)===e.Primitive.Mode.TRIANGLES,"size"===r.target);o.setArray(c<=65534?new Uint16Array(i):i);for(const e of s.indicesToAttributes.get(t)){const r=e.clone();A(r,a,c);for(const n of s.attributesToPrimitives.get(e))if(n.getIndices()===t&&n.swap(t,o),n.getIndices()===o){n.swap(e,r);for(const t of n.listTargets())t.swap(e,r)}}}return Promise.resolve(t.transform(Y({propertyTypes:[e.PropertyType.ACCESSOR],keepAttributes:!0,keepIndices:!0}))).then(function(){s.indicesToAttributes.size?o.debug(`${mt}: Complete.`):o.warn(`${mt}: No qualifying primitives found; may need to weld first.`)})})}catch(e){return Promise.reject(e)}})}function yt(t,r){if(void 0===r&&(r=Infinity),Number.isFinite(r)&&r%4||r<=0)throw new Error("Limit must be positive multiple of four.");const n=t.getAttribute("POSITION").getCount(),o=t.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).length,s=new Uint16Array(4*o),i=new Float32Array(4*o),a=new Float32Array(4*o),c=new Uint32Array(4*o),l=new Uint32Array(4*o);for(let e=0;e<n;e++){Tt(t,e,"WEIGHTS",i),Tt(t,e,"JOINTS",c);for(let e=0;e<4*o;e++)s[e]=e;s.sort((e,t)=>i[e]>i[t]?-1:1);for(let e=0;e<s.length;e++)a[e]=i[s[e]],l[e]=c[s[e]];At(t,e,"WEIGHTS",a),At(t,e,"JOINTS",l)}for(let e=o;4*e>r;e--){const r=t.getAttribute("WEIGHTS_"+(e-1)),n=t.getAttribute("JOINTS_"+(e-1));t.setAttribute("WEIGHTS_"+(e-1),null),t.setAttribute("JOINTS_"+(e-1),null),1===r.listParents().length&&r.dispose(),1===n.listParents().length&&n.dispose()}!function(t){if(!function(e){const t=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).map(t=>e.getAttribute(t)),r=t.map(e=>e.getNormalized()),n=t.map(e=>e.getComponentType());return 1===new Set(r).size&&1===new Set(n).size}(t))return;const r=t.getAttribute("POSITION").getCount(),n=t.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).length,o=t.getAttribute("WEIGHTS_0"),s=o.getArray(),i=o.getComponentType(),a=o.getNormalized(),c=a?i:void 0,l=a?e.MathUtils.decodeNormalizedInt(1,i):Number.EPSILON,u=new Uint32Array(4*n).fill(0),f=s.slice(0,4*n).fill(0);for(let n=0;n<r;n++){Tt(t,n,"JOINTS",u),Tt(t,n,"WEIGHTS",f,c);let r=Et(f,c);if(0!==r){if(Math.abs(1-r)>l)for(let t=0;t<f.length;t++)if(a){const n=e.MathUtils.encodeNormalizedInt(f[t]/r,i);f[t]=e.MathUtils.decodeNormalizedInt(n,i)}else f[t]/=r;if(r=Et(f,c),a&&1!==r)for(let t=f.length-1;t>=0;t--)if(f[t]>0){f[t]+=e.MathUtils.encodeNormalizedInt(1-r,i);break}for(let e=f.length-1;e>=0;e--)0===f[e]&&(u[e]=0);At(t,n,"JOINTS",u),At(t,n,"WEIGHTS",f,c)}}}(t)}function Tt(t,r,n,o,s){let i;const a=[0,0,0,0];for(let c=0;i=t.getAttribute(`${n}_${c}`);c++){i.getElement(r,a);for(let t=0;t<4;t++)o[4*c+t]=s?e.MathUtils.encodeNormalizedInt(a[t],s):a[t]}return o}function At(t,r,n,o,s){let i;const a=[0,0,0,0];for(let c=0;i=t.getAttribute(`${n}_${c}`);c++){for(let t=0;t<4;t++)a[t]=s?e.MathUtils.decodeNormalizedInt(o[4*c+t],s):o[4*c+t];i.setElement(r,a)}}function Et(t,r){let n=0;for(let o=0;o<t.length;o++)n+=r?e.MathUtils.decodeNormalizedInt(t[o],r):t[o];return n}const St="quantize",Pt=[Int8Array,Int16Array,Int32Array],{TRANSLATION:Mt,ROTATION:It,SCALE:vt,WEIGHTS:bt}=e.AnimationChannel.TargetPath,Nt=[Mt,It,vt],xt={pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0};function Rt(t){void 0===t&&(t=xt);const n={...xt,...t};return n.patternTargets=n.patternTargets||n.pattern,l(St,function(t){try{const o=t.getLogger(),s=t.getRoot();let i;t.createExtension(r.KHRMeshQuantization).setRequired(!0),"scene"===n.quantizationVolume&&(i=wt(function(e){const t=e[0];for(const r of e)w(t.min,t.min,r.min),O(t.max,t.max,r.max);return t}(s.listMeshes().map(_t))));for(const e of t.getRoot().listMeshes()){"mesh"===n.quantizationVolume&&(i=wt(_t(e))),i&&n.pattern.test("POSITION")&&(Ot(t,e,i),zt(e,1/i.scale));for(const r of e.listPrimitives()){Ct(t,r,i,n);for(const e of r.listTargets())Ct(t,e,i,n)}}return Promise.resolve(t.transform(Y({propertyTypes:[e.PropertyType.ACCESSOR,e.PropertyType.SKIN,e.PropertyType.MATERIAL],keepAttributes:!0,keepIndices:!0,keepLeaves:!0,keepSolidTextures:!0}),B({propertyTypes:[e.PropertyType.ACCESSOR,e.PropertyType.MATERIAL,e.PropertyType.SKIN],keepUniqueNames:!0}))).then(function(){o.debug(`${St}: Complete.`)})}catch(e){return Promise.reject(e)}})}function Ct(t,r,n,o){const s=r instanceof e.PrimitiveTarget,i=t.getLogger();for(const t of r.listSemantics()){if(!s&&!o.pattern.test(t))continue;if(s&&!o.patternTargets.test(t))continue;const l=r.getAttribute(t),{bits:u,ctor:f}=Ut(t,l,i,o);if(!f)continue;if(u<8||u>16)throw new Error(`${St}: Requires bits = 8–16.`);if(l.getComponentSize()<=u/8)continue;const g=l.clone();if("POSITION"===t){const t=n.scale,o=[];r instanceof e.Primitive?x(o,Gt(n)):((a=o)[0]=(c=[1/t,1/t,1/t])[0],a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=c[1],a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=c[2],a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1);for(let e=0,t=[0,0,0],r=g.getCount();e<r;e++)g.getElement(e,t),g.setElement(e,z(t,t,o))}Ft(g,f,u),r.swap(l,g)}var a,c;if(o.normalizeWeights&&r.getAttribute("WEIGHTS_0")&&yt(r,Infinity),r instanceof e.Primitive&&r.getIndices()&&r.listAttributes().length&&r.listAttributes()[0].getCount()<65535){const e=r.getIndices();e.setArray(new Uint16Array(e.getArray()))}}function wt(e){const{min:t,max:r}=e,n=Math.max((r[0]-t[0])/2,(r[1]-t[1])/2,(r[2]-t[2])/2);return{offset:[t[0]+(r[0]-t[0])/2,t[1]+(r[1]-t[1])/2,t[2]+(r[2]-t[2])/2],scale:n}}function Ot(t,r,n){const o=Gt(n);for(const s of r.listParents()){if(!(s instanceof e.Node))continue;const i=s.listParents().filter(t=>t instanceof e.AnimationChannel),a=i.some(e=>Nt.includes(e.getTargetPath())),c=s.listChildren().length>0,l=s.getSkin();if(l){s.setSkin($t(l,n));continue}const u=s.getExtension("EXT_mesh_gpu_instancing");if(u){s.setExtension("EXT_mesh_gpu_instancing",Lt(u,n));continue}let f;c||a?(f=t.createNode("").setMesh(r),s.addChild(f).setMesh(null),i.filter(e=>e.getTargetPath()===bt).forEach(e=>e.setTargetNode(f))):f=s;const g=f.getMatrix();R(g,g,o),f.setMatrix(g)}}function $t(e,t){e=e.clone();const r=Gt(t),n=e.getInverseBindMatrices().clone(),o=[];for(let e=0,t=n.getCount();e<t;e++)n.getElement(e,o),R(o,o,r),n.setElement(e,o);return e.setInverseBindMatrices(n)}function Lt(t,r){var n,o,s;if(!t.getAttribute("TRANSLATION")&&!t.getAttribute("ROTATION")&&!t.getAttribute("SCALE"))return t;const i=null==(n=(t=t.clone()).getAttribute("TRANSLATION"))?void 0:n.clone(),a=null==(o=t.getAttribute("ROTATION"))?void 0:o.clone(),c=null==(s=t.getAttribute("SCALE"))?void 0:s.clone(),l=i||a||c,u=[0,0,0],f=[0,0,0,1],g=[1,1,1],p=[0,0,0],m=[0,0,0,1],h=[1,1,1],d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],y=Gt(r);for(let t=0,r=l.getCount();t<r;t++)e.MathUtils.compose(i?i.getElement(t,p):u,a?a.getElement(t,m):f,c?c.getElement(t,h):g,d),R(d,d,y),e.MathUtils.decompose(d,p,m,h),i&&i.setElement(t,p),a&&a.setElement(t,m),c&&c.setElement(t,h);return i&&t.setAttribute("TRANSLATION",i),a&&t.setAttribute("ROTATION",a),c&&t.setAttribute("SCALE",c),t}function zt(e,t){for(const r of e.listPrimitives()){let e=r.getMaterial();if(!e)continue;let n=e.getExtension("KHR_materials_volume");!n||n.getThicknessFactor()<=0||(n=n.clone().setThicknessFactor(n.getThicknessFactor()*t),e=e.clone().setExtension("KHR_materials_volume",n),r.setMaterial(e))}}function Ft(e,t,r){const n=new t(e.getArray().length),o=Pt.includes(t)?1:0,s=r-o,i=8*t.BYTES_PER_ELEMENT-o,a=Math.pow(2,s)-1,c=i-s,l=2*s-i,u=[o>0?-1:0,1];for(let t=0,r=0,o=[];t<e.getCount();t++){e.getElement(t,o);for(let e=0;e<o.length;e++){let t=qt(o[e],u);t=Math.round(Math.abs(t)*a),t=t<<c|t>>l,n[r++]=t*Math.sign(o[e])}}e.setArray(n).setNormalized(!0).setSparse(!1)}function Ut(e,t,r,n){const o=t.getMinNormalized([]),s=t.getMaxNormalized([]);let i,a;if("POSITION"===e)i=n.quantizePosition,a=i<=8?Int8Array:Int16Array;else if("NORMAL"===e||"TANGENT"===e)i=n.quantizeNormal,a=i<=8?Int8Array:Int16Array;else if(e.startsWith("COLOR_"))i=n.quantizeColor,a=i<=8?Uint8Array:Uint16Array;else if(e.startsWith("TEXCOORD_")){if(o.some(e=>e<0)||s.some(e=>e>1))return r.warn(`${St}: Skipping ${e}; out of [0,1] range.`),{bits:-1};i=n.quantizeTexcoord,a=i<=8?Uint8Array:Uint16Array}else{if(e.startsWith("JOINTS_"))return i=Math.max(...t.getMax([]))<=255?8:16,a=i<=8?Uint8Array:Uint16Array,t.getComponentSize()>i/8&&t.setArray(new a(t.getArray())),{bits:-1};if(e.startsWith("WEIGHTS_")){if(o.some(e=>e<0)||s.some(e=>e>1))return r.warn(`${St}: Skipping ${e}; out of [0,1] range.`),{bits:-1};i=n.quantizeWeight,a=i<=8?Uint8Array:Uint16Array}else{if(!e.startsWith("_"))throw new Error(`${St}: Unexpected semantic, "${e}".`);if(o.some(e=>e<-1)||s.some(e=>e>1))return r.warn(`${St}: Skipping ${e}; out of [-1,1] range.`),{bits:-1};i=n.quantizeGeneric,a=a=o.some(e=>e<0)?i<=8?Int8Array:Int16Array:i<=8?Uint8Array:Uint16Array}}return{bits:i,ctor:a}}function _t(e){const t=[],r=[];for(const n of e.listPrimitives()){const e=n.getAttribute("POSITION");e&&t.push(e);for(const e of n.listTargets()){const t=e.getAttribute("POSITION");t&&r.push(t)}}if(0===t.length)throw new Error(`${St}: Missing "POSITION" attribute.`);const n=kt(t,3);if(r.length>0){const{min:e,max:t}=kt(r,3);w(n.min,n.min,w(e,$(e,e,2),[0,0,0])),O(n.max,n.max,O(t,$(t,t,2),[0,0,0]))}return n}function kt(e,t){const r=new Array(t).fill(Infinity),n=new Array(t).fill(-Infinity),o=[],s=[];for(const i of e){i.getMinNormalized(o),i.getMaxNormalized(s);for(let e=0;e<t;e++)r[e]=Math.min(r[e],o[e]),n[e]=Math.max(n[e],s[e])}return{min:r,max:n}}function Gt(e){return n=e.offset,g=(s=(r=[0,0,0,1])[0])*(l=s+s),p=s*(u=(i=r[1])+i),m=s*(f=(a=r[2])+a),d=i*f,T=(c=r[3])*l,A=c*u,E=c*f,P=(o=[e.scale,e.scale,e.scale])[1],M=o[2],(t=[])[0]=(1-((h=i*u)+(y=a*f)))*(S=o[0]),t[1]=(p+E)*S,t[2]=(m-A)*S,t[3]=0,t[4]=(p-E)*P,t[5]=(1-(g+y))*P,t[6]=(d+T)*P,t[7]=0,t[8]=(m+A)*M,t[9]=(d-T)*M,t[10]=(1-(g+h))*M,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t;var t,r,n,o,s,i,a,c,l,u,f,g,p,m,h,d,y,T,A,E,S,P,M}function qt(e,t){return Math.min(Math.max(e,t[0]),t[1])}const Bt={level:"high",...xt},Dt="meshopt",jt="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function Ht(e,t,r){if(!e.s){if(r instanceof Wt){if(!r.s)return void(r.o=Ht.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(Ht.bind(null,e,t),Ht.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}const Wt=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,o=this.s;if(o){const e=1&o?t:r;if(e){try{Ht(n,1,e(this.v))}catch(e){Ht(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?Ht(n,1,t?t(o):o):r?Ht(n,1,r(o)):Ht(n,2,o)}catch(e){Ht(n,2,e)}},n},e}();function Xt(e){return e instanceof Wt&&1&e.s}const Kt="metalRough",Vt="unweld";function Jt(e){return l(Vt,e=>{const t=e.getLogger(),r=new Map;for(const n of e.getRoot().listMeshes())for(const e of n.listPrimitives()){const n=e.getIndices();if(!n)continue;const o=e.getAttribute("POSITION").getCount();for(const o of e.listAttributes())e.swap(o,Zt(o,n,t,r)),1===o.listParents().length&&o.dispose();for(const o of e.listTargets())for(const e of o.listAttributes())o.swap(e,Zt(e,n,t,r)),1===e.listParents().length&&e.dispose();const s=e.getAttribute("POSITION").getCount();t.debug(`${Vt}: ${h(o,s)} vertices.`),e.setIndices(null),1===n.listParents().length&&n.dispose()}t.debug(`${Vt}: Complete.`)})}function Zt(e,t,r,n){if(n.has(e)&&n.get(e).has(t))return r.debug(`${Vt}: Cache hit for reused attribute, "${e.getName()}".`),n.get(e).get(t);const o=e.clone(),s=e.getArray().constructor;o.setArray(new s(t.getCount()*e.getElementSize()));const i=[];for(let r=0;r<t.getCount();r++)o.setElement(r,e.getElement(t.getScalar(r),i));return n.has(e)||n.set(e,new Map),n.get(e).set(t,o),o}const Qt="normals",Yt={overwrite:!1};function er(e,t,r){const n=[t[0]-e[0],t[1]-e[1],t[2]-e[2]],o=[r[0]-e[0],r[1]-e[1],r[2]-e[2]];return L([0,0,0],[n[1]*o[2]-n[2]*o[1],n[2]*o[0]-n[0]*o[2],n[0]*o[1]-n[1]*o[0]])}const tr="palette",rr={blockSize:4,min:2};function nr(e){const t=Math.round(255*e).toString(16);return 1===t.length?"0"+t:t}function or(t){return e.ColorUtils.convertLinearToSRGB(t,t),t.map(nr).join("")}function sr(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function ir(e,t,r,n){for(let o=0;o<n;o++)for(let s=0;s<n;s++)e.set(t*n+o,s,0,255*r[0]),e.set(t*n+o,s,1,255*r[1]),e.set(t*n+o,s,2,255*r[2]),e.set(t*n+o,s,3,255*r[3])}const ar="partition",cr={animations:!0,meshes:!0};function lr(e,t){let r=`${e}.bin`,n=1;for(;t.has(r);)r=`${e}_${n++}.bin`;return r}var ur;function fr(e,t,r){for(let n=0,o=r.length;n<o;n++)r[n]=e[t*o+n];return r}function gr(e,t,r){for(let n=0,o=r.length;n<o;n++)e[t*o+n]=r[n]}function pr(e,t,r=0){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(Math.abs(e[n]-t[n])>r)return!1;return!0}function mr(e,t,r){return e*(1-r)+t*r}function hr(e,t,r,n){for(let o=0;o<t.length;o++)e[o]=mr(t[o],r[o],n);return e}function dr(e,t,r,n){let o,s,i,a,c,l=t[0],u=t[1],f=t[2],g=t[3],p=r[0],m=r[1],h=r[2],d=r[3];return s=l*p+u*m+f*h+g*d,s<0&&(s=-s,p=-p,m=-m,h=-h,d=-d),1-s>1e-6?(o=Math.acos(s),i=Math.sin(o),a=Math.sin((1-n)*o)/i,c=Math.sin(n*o)/i):(a=1-n,c=n),e[0]=a*l+c*p,e[1]=a*u+c*m,e[2]=a*f+c*h,e[3]=a*g+c*d,e}function yr(e,t){const r=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}(e,t);return Math.acos(2*r*r-1)}!function(e){e[e.STEP=0]="STEP",e[e.LERP=1]="LERP",e[e.SLERP=2]="SLERP"}(ur||(ur={}));const Tr="resample",Ar=new Float32Array(0),Er={ready:Promise.resolve(),resample:function(e,t,r,n=1e-4){const o=t.length/e.length,s=new Array(o).fill(0),i=new Array(o).fill(0),a=new Array(o).fill(0),c=new Array(o).fill(0),l=e.length-1;let u=1;for(let o=1;o<l;++o){const l=e[u-1],f=e[o],g=e[o+1],p=(f-l)/(g-l);let m=!1;if(f!==g&&(1!==o||f!==e[0]))if(fr(t,u-1,c),fr(t,o,i),fr(t,o+1,a),"slerp"===r){const e=dr(s,c,a,p),t=yr(c,i)+yr(i,a);m=!pr(i,e,n)||t+Number.EPSILON>=Math.PI}else"lerp"===r?m=!pr(i,hr(s,c,a,p),n):"step"===r&&(m=!pr(i,c)||!pr(i,a));m&&(o!==u&&(e[u]=e[o],gr(t,u,fr(t,o,s))),u++)}return l>0&&(e[u]=e[l],gr(t,u,fr(t,l,s)),u++),u},tolerance:1e-4};function Sr(t,r,n){if(t instanceof Float32Array)return t.slice();const o=new Float32Array(t);if(!n)return o;for(let t=0;t<o.length;t++)o[t]=e.MathUtils.decodeNormalizedInt(o[t],r);return o}function Pr(t,r,n){if(r===e.Accessor.ComponentType.FLOAT)return t.slice();const o=new(0,e.ComponentTypeToTypedArray[r])(t.length);for(let s=0;s<o.length;s++)o[s]=n?e.MathUtils.encodeNormalizedInt(t[s],r):t[s];return o}const Mr="sequence",Ir={name:"",fps:10,pattern:/.*/,sort:!0},vr="simplify",br={ratio:0,error:1e-4,lockBorder:!1};function Nr(t,r,n){const o={...br,...n},s=o.simplifier,i=t.getLogger(),a=r.getAttribute("POSITION"),c=r.getIndices(),l=a.getCount();let u=a.getArray(),f=c.getArray();if(a.getComponentType()!==e.Accessor.ComponentType.FLOAT)if(a.getNormalized()){const e=u,t=new Float32Array(e.length);for(let r=0,n=a.getCount(),o=[];r<n;r++)o=a.getElement(r,o),a.setArray(t).setElement(r,o).setArray(e);u=t}else u=new Float32Array(u);c.getComponentType()!==e.Accessor.ComponentType.UNSIGNED_INT&&(f=new Uint32Array(f));const g=3*Math.floor(o.ratio*l/3),[p,m]=s.simplify(f,u,3,g,o.error,o.lockBorder?["LockBorder"]:[]),[T,E]=s.compactMesh(p);i.debug(`${vr}: ${h(a.getCount(),E)} vertices, error: ${m.toFixed(4)}.`);for(const e of d(r)){const t=e.clone();A(t,T,E),y(r,e,t),1===e.listParents().length&&e.dispose()}const S=c.clone();return S.setArray(l<=65534?new Uint16Array(p):p),r.setIndices(S),1===c.listParents().length&&c.dispose(),r}const xr="sparse",Rr={ratio:1/3},Cr="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function wr(e,t,r){if(!e.s){if(r instanceof Or){if(!r.s)return void(r.o=wr.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(wr.bind(null,e,t),wr.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}const Or=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,o=this.s;if(o){const e=1&o?t:r;if(e){try{wr(n,1,e(this.v))}catch(e){wr(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?wr(n,1,t?t(o):o):r?wr(n,1,r(o)):wr(n,2,o)}catch(e){wr(n,2,e)}},n},e}();function $r(e){return e instanceof Or&&1&e.s}const Lr="textureResize";var zr;exports.TextureResizeFilter=void 0,(zr=exports.TextureResizeFilter||(exports.TextureResizeFilter={})).LANCZOS3="lanczos3",zr.LANCZOS2="lanczos2";const Fr={size:[2048,2048],filter:exports.TextureResizeFilter.LANCZOS3,pattern:null,slots:null},Ur=function(r,n){try{const o={...qr,...n},i=o.encoder,c=Br(r),l=o.targetFormat||c,u=r.getMimeType(),f=`image/${l}`,g=r.getImage();return Promise.resolve(i?function(t,r,n,o){try{const r=o.encoder;let s={};const i=Dr(n);switch(i){case"jpeg":s={quality:o.quality};break;case"png":s={quality:o.quality,effort:jr(o.effort,100,10)};break;case"webp":s={quality:o.quality,effort:jr(o.effort,100,6),lossless:o.lossless,nearLossless:o.nearLossless};break;case"avif":s={quality:o.quality,effort:jr(o.effort,100,9),lossless:o.lossless}}const a=r(t).toFormat(i,s);o.resize&&a.resize(o.resize[0],o.resize[1],{fit:"inside",kernel:o.resizeFilter,withoutEnlargement:!0});const c=e.BufferUtils.toView;return Promise.resolve(a.toBuffer()).then(function(t){return c.call(e.BufferUtils,t)})}catch(e){return Promise.reject(e)}}(g,0,f,o):function(e,r,n,o){try{return Promise.resolve(t.getPixels(e,r)).then(function(e){if(o.resize){const[r,i]=e.shape,c=P([r,i],o.resize),l=a.default(new Uint8Array(c[0]*c[1]*4),[...c,4]);return o.resizeFilter===exports.TextureResizeFilter.LANCZOS3?s.lanczos3(e,l):s.lanczos2(e,l),t.savePixels(l,n)}return t.savePixels(e,n)})}catch(e){return Promise.reject(e)}}(g,u,f,o)).then(function(t){if(u===f&&t.byteLength>=g.byteLength&&!o.resize);else if(u===f)r.setImage(t);else{const n=e.ImageUtils.mimeTypeToExtension(u),o=e.ImageUtils.mimeTypeToExtension(f),s=r.getURI().replace(new RegExp(`\\.${n}$`),`.${o}`);r.setImage(t).setMimeType(f).setURI(s)}})}catch(e){return Promise.reject(e)}},_r="textureCompress",kr=["jpeg","png","webp","avif"],Gr=["image/jpeg","image/png","image/webp","image/avif"],qr={resizeFilter:exports.TextureResizeFilter.LANCZOS3,pattern:void 0,formats:void 0,slots:void 0,quality:void 0,effort:void 0,lossless:!1,nearLossless:!1};function Br(e){return Dr(e.getMimeType())}function Dr(e){const t=e.split("/").pop();if(!t||!kr.includes(t))throw new Error(`Unknown MIME type "${e}".`);return t}function jr(e,t,r){if(null!=e)return Math.round(e/t*r)}const Hr="tangents",Wr={overwrite:!1};function Xr(e){const t=e.getMaterial();if(!t)return"TEXCOORD_0";const r=t.getNormalTextureInfo();if(!r)return"TEXCOORD_0";const n=`TEXCOORD_${r.getTexCoord()}`;return e.getAttribute(n)?n:"TEXCOORD_0"}function Kr(t,r,n,o,s){return t.getMode()===e.Primitive.Mode.TRIANGLES&&t.getAttribute("POSITION")&&t.getAttribute("NORMAL")&&t.getAttribute("TEXCOORD_0")?t.getAttribute("TANGENT")&&!s?(r.debug(`${Hr}: Skipping primitive ${o} of mesh "${n}": TANGENT found.`),!1):!t.getIndices()||(r.warn(`${Hr}: Skipping primitive ${o} of mesh "${n}": primitives must be unwelded.`),!1):(r.debug(`${Hr}: Skipping primitive ${o} of mesh "${n}": primitives must have attributes=[POSITION, NORMAL, TEXCOORD_0] and mode=TRIANGLES.`),!1)}const Vr="unpartition",Jr="vertexColorSpace",Zr=Qr;function Qr(e){return l(Jr,t=>{const r=t.getLogger(),n=(e.inputColorSpace||e.inputEncoding||"").toLowerCase();if("srgb-linear"===n)return void r.info(`${Jr}: Vertex colors already linear. Skipping conversion.`);if("srgb"!==n)return void r.error(`${Jr}: Unknown input color space "${n}" – should be "srgb" or "srgb-linear". Skipping conversion.`);const o=new Set;function s(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function i(e){const t=[0,0,0];let r;for(let n=0;r=e.getAttribute(`COLOR_${n}`);n++)if(!o.has(r)){for(let e=0;e<r.getCount();e++)r.getElement(e,t),t[0]=s(t[0]),t[1]=s(t[1]),t[2]=s(t[2]),r.setElement(e,t);o.add(r)}}t.getRoot().listMeshes().forEach(e=>e.listPrimitives().forEach(i)),r.debug(`${Jr}: Complete.`)})}exports.DRACO_DEFAULTS=ze,exports.FLATTEN_DEFAULTS={},exports.JOIN_DEFAULTS=ct,exports.MESHOPT_DEFAULTS=Bt,exports.PALETTE_DEFAULTS=rr,exports.QUANTIZE_DEFAULTS=xt,exports.SIMPLIFY_DEFAULTS=br,exports.TEXTURE_COMPRESS_DEFAULTS=qr,exports.TEXTURE_COMPRESS_SUPPORTED_FORMATS=kr,exports.TEXTURE_RESIZE_DEFAULTS=Fr,exports.WELD_DEFAULTS=ge,exports.center=function(t){void 0===t&&(t=I);const r={...I,...t};return l(M,t=>{const n=t.getLogger(),o=t.getRoot(),s=o.listAnimations().length>0||o.listSkins().length>0;t.getRoot().listScenes().forEach((i,a)=>{let c;if(n.debug(`${M}: Scene ${a+1} / ${o.listScenes().length}.`),"string"==typeof r.pivot){const t=e.getBounds(i);c=[(t.max[0]-t.min[0])/2+t.min[0],(t.max[1]-t.min[1])/2+t.min[1],(t.max[2]-t.min[2])/2+t.min[2]],"above"===r.pivot&&(c[1]=t.max[1]),"below"===r.pivot&&(c[1]=t.min[1])}else c=r.pivot;n.debug(`${M}: Pivot "${c.join(", ")}".`);const l=[-1*c[0],-1*c[1],-1*c[2]];if(s){n.debug(`${M}: Model contains animation or skin. Adding a wrapper node.`);const e=t.createNode("Pivot").setTranslation(l);i.listChildren().forEach(t=>e.addChild(t)),i.addChild(e)}else n.debug(`${M}: Skipping wrapper, offsetting all root nodes.`),i.listChildren().forEach(e=>{const t=e.getTranslation();e.setTranslation([t[0]+l[0],t[1]+l[1],t[2]+l[2]])})}),n.debug(`${M}: Complete.`)})},exports.clearNodeParent=b,exports.clearNodeTransform=function(t){const r=t.getMesh(),n=t.getMatrix();r&&!e.MathUtils.eq(n,Ce)&&Re(r,n);for(const e of t.listChildren()){const t=e.getMatrix();R(t,t,n),e.setMatrix(t)}return t.setMatrix(Ce)},exports.colorspace=Zr,exports.compressTexture=Ur,exports.createTransform=l,exports.dedup=B,exports.dequantize=function(e){void 0===e&&(e=Oe);const t={...Oe,...e};return l(we,e=>{const n=e.getLogger();for(const r of e.getRoot().listMeshes())for(const e of r.listPrimitives())$e(e,t);e.createExtension(r.KHRMeshQuantization).dispose(),n.debug(`${we}: Complete.`)})},exports.dequantizePrimitive=$e,exports.draco=function(e){void 0===e&&(e=ze);const t={...ze,...e};return l("draco",function(e){try{return Promise.resolve(e.transform(pe({tolerance:0}))).then(function(){e.createExtension(r.KHRDracoMeshCompression).setRequired(!0).setEncoderOptions({method:"edgebreaker"===t.method?r.KHRDracoMeshCompression.EncoderMethod.EDGEBREAKER:r.KHRDracoMeshCompression.EncoderMethod.SEQUENTIAL,encodeSpeed:t.encodeSpeed,decodeSpeed:t.decodeSpeed,quantizationBits:{POSITION:t.quantizePosition,NORMAL:t.quantizeNormal,COLOR:t.quantizeColor,TEX_COORD:t.quantizeTexcoord,GENERIC:t.quantizeGeneric},quantizationVolume:t.quantizationVolume})})}catch(e){return Promise.reject(e)}})},exports.flatten=function(t){return l(Fe,function(t){try{const r=t.getRoot(),n=t.getLogger(),o=new Set;for(const e of r.listSkins())for(const t of e.listJoints())o.add(t);const s=new Set;for(const e of r.listAnimations())for(const t of e.listChannels()){const e=t.getTargetNode();e&&"weights"!==t.getTargetPath()&&s.add(e)}const i=new Set,a=new Set;for(const e of r.listScenes())e.traverse(e=>{const t=e.getParentNode();t&&((o.has(t)||i.has(t))&&i.add(e),(s.has(t)||a.has(t))&&a.add(e))});for(const e of r.listScenes())e.traverse(e=>{s.has(e)||i.has(e)||a.has(e)||b(e)});return s.size&&n.debug(`${Fe}: Flattening node hierarchies with TRS animation not yet supported.`),Promise.resolve(t.transform(Y({propertyTypes:[e.PropertyType.NODE],keepLeaves:!1}))).then(function(){n.debug(`${Fe}: Complete.`)})}catch(e){return Promise.reject(e)}})},exports.getGLPrimitiveCount=f,exports.getNodeScene=function(e){return v(e)[0]||null},exports.getTextureChannelMask=pt,exports.getTextureColorSpace=W,exports.inspect=function(e){return{scenes:Ue(e),meshes:_e(e),materials:ke(e),textures:Ge(e),animations:qe(e)}},exports.instance=function(t){void 0===t&&(t=Xe);const n={...Xe,...t};return l(We,t=>{const o=t.getLogger(),s=t.getRoot();if(s.listAnimations().length)return o.warn(`${We}: Instancing is not currently supported for animated models.`),void o.debug(`${We}: Complete.`);const i=t.createExtension(r.EXTMeshGPUInstancing);let a=0,c=0;for(const r of s.listScenes()){const s=new Map;r.traverse(e=>{const t=e.getMesh();t&&s.set(t,(s.get(t)||new Set).add(e))});const l=[];for(const u of Array.from(s.keys())){const f=Array.from(s.get(u));if(f.length<n.min)continue;if(f.some(e=>e.getSkin()))continue;if(u.listPrimitives().some(Ve)&&f.some(Je))continue;const g=Ze(t,i,u,f.length),p=g.getAttribute("TRANSLATION"),m=g.getAttribute("ROTATION"),h=g.getAttribute("SCALE"),d=t.createNode().setMesh(u).setExtension("EXT_mesh_gpu_instancing",g);r.addChild(d);let y=!1,T=!1,A=!1;for(let t=0;t<f.length;t++){let r,n,o;const s=f[t];p.setElement(t,r=s.getWorldTranslation()),m.setElement(t,n=s.getWorldRotation()),h.setElement(t,o=s.getWorldScale()),e.MathUtils.eq(r,[0,0,0])||(y=!0),e.MathUtils.eq(n,[0,0,0,1])||(T=!0),e.MathUtils.eq(o,[1,1,1])||(A=!0),s.setMesh(null),l.push(s)}y||p.dispose(),T||m.dispose(),A||h.dispose(),Ke(l,o),a++,c+=f.length}}o.info(a>0?`${We}: Created ${a} batches, with ${c} total instances.`:`${We}: No meshes with >=${n.min} parent nodes were found.`),0===i.listProperties().length&&i.dispose(),o.debug(`${We}: Complete.`)})},exports.isTransformPending=u,exports.join=function(e){void 0===e&&(e=ct);const t={...ct,...e};return l(tt,function(e){try{const r=e.getRoot(),n=e.getLogger();for(const n of r.listScenes())lt(e,n,t),n.traverse(r=>lt(e,r,t));return Promise.resolve(e.transform(Y({propertyTypes:[nt,ot,st,it],keepAttributes:!0,keepIndices:!0,keepLeaves:!1}))).then(function(){n.debug(`${tt}: Complete.`)})}catch(e){return Promise.reject(e)}})},exports.joinPrimitives=Ye,exports.listNodeScenes=v,exports.listTextureChannels=function(t){const r=pt(t),n=[];return r&e.TextureChannel.R&&n.push(e.TextureChannel.R),r&e.TextureChannel.G&&n.push(e.TextureChannel.G),r&e.TextureChannel.B&&n.push(e.TextureChannel.B),r&e.TextureChannel.A&&n.push(e.TextureChannel.A),n},exports.listTextureInfo=function(t){const r=t.getGraph(),n=new Set;for(const o of r.listParentEdges(t)){const t=o.getParent(),s=o.getName()+"Info";for(const o of r.listChildEdges(t)){const t=o.getChild();t instanceof e.TextureInfo&&o.getName()===s&&n.add(t)}}return Array.from(n)},exports.listTextureInfoByMaterial=X,exports.listTextureSlots=K,exports.meshopt=function(e){const t={...Bt,...e},n=t.encoder;if(!n)throw new Error(`${Dt}: encoder dependency required — install "meshoptimizer".`);return l(Dt,function(e){try{let o,s,i=t.quantizeNormal;return"medium"===t.level?(o=/.*/,s=/.*/):(o=/^(POSITION|TEXCOORD|JOINTS|WEIGHTS)(_\d+)?$/,s=/^(POSITION|TEXCOORD|JOINTS|WEIGHTS|NORMAL|TANGENT)(_\d+)?$/,i=Math.min(i,8)),Promise.resolve(e.transform(dt({encoder:n,target:"size"}),Rt({...t,pattern:o,patternTargets:s,quantizeNormal:i}))).then(function(){e.createExtension(r.EXTMeshoptCompression).setRequired(!0).setEncoderOptions({method:"medium"===t.level?r.EXTMeshoptCompression.EncoderMethod.QUANTIZE:r.EXTMeshoptCompression.EncoderMethod.FILTER})})}catch(e){return Promise.reject(e)}})},exports.metalRough=function(e){return l(Kt,function(e){try{function t(){i.dispose();for(const e of a)e&&1===e.listParents().length&&e.dispose();n.debug(`${Kt}: Complete.`)}const n=e.getLogger();if(!e.getRoot().listExtensionsUsed().map(e=>e.extensionName).includes("KHR_materials_pbrSpecularGlossiness"))return n.warn(`${Kt}: KHR_materials_pbrSpecularGlossiness not found on document.`),Promise.resolve();const o=e.createExtension(r.KHRMaterialsIOR),s=e.createExtension(r.KHRMaterialsSpecular),i=e.createExtension(r.KHRMaterialsPBRSpecularGlossiness),a=new Set,l=function(e,t,r){if("function"==typeof e[jt]){var n,o,s,i=e[jt]();if(function e(r){try{for(;!(n=i.next()).done;)if((r=t(n.value))&&r.then){if(!Xt(r))return void r.then(e,s||(s=Ht.bind(null,o=new Wt,2)));r=r.v}o?Ht(o,1,r):o=r}catch(e){Ht(o||(o=new Wt),2,e)}}(),i.return){var a=function(e){try{n.done||i.return()}catch(e){}return e};if(o&&o.then)return o.then(a,function(e){throw a(e)});a()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var c=[],l=0;l<e.length;l++)c.push(e[l]);return function(e,t,r){var n,o,s=-1;return function r(i){try{for(;++s<e.length;)if((i=t(s))&&i.then){if(!Xt(i))return void i.then(r,o||(o=Ht.bind(null,n=new Wt,2)));i=i.v}n?Ht(n,1,i):n=i}catch(e){Ht(n||(n=new Wt),2,e)}}(),n}(c,function(e){return t(c[e])})}(e.getRoot().listMaterials(),function(t){function r(){t.setExtension("KHR_materials_pbrSpecularGlossiness",null)}const n=t.getExtension("KHR_materials_pbrSpecularGlossiness");if(!n)return;const i=s.createSpecular().setSpecularFactor(1).setSpecularColorFactor(n.getSpecularFactor());a.add(n.getSpecularGlossinessTexture()),a.add(t.getBaseColorTexture()),a.add(t.getMetallicRoughnessTexture()),t.setBaseColorFactor(n.getDiffuseFactor()).setMetallicFactor(0).setRoughnessFactor(1).setExtension("KHR_materials_ior",o.createIOR().setIOR(1e3)).setExtension("KHR_materials_specular",i);const l=n.getDiffuseTexture();l&&(t.setBaseColorTexture(l),t.getBaseColorTextureInfo().copy(n.getDiffuseTextureInfo()));const u=n.getSpecularGlossinessTexture(),f=function(){if(u){const r=n.getSpecularGlossinessTextureInfo(),o=e.createTexture();return Promise.resolve(c(u,o,(e,t,r)=>{e.set(t,r,3,255)})).then(function(){i.setSpecularTexture(o),i.setSpecularColorTexture(o),i.getSpecularTextureInfo().copy(r),i.getSpecularColorTextureInfo().copy(r);const s=n.getGlossinessFactor(),a=e.createTexture();return Promise.resolve(c(u,a,(e,t,r)=>{const n=255-Math.round(e.get(t,r,3)*s);e.set(t,r,0,0),e.set(t,r,1,n),e.set(t,r,2,0),e.set(t,r,3,255)})).then(function(){t.setMetallicRoughnessTexture(a),t.getMetallicRoughnessTextureInfo().copy(r)})})}i.setSpecularColorFactor(n.getSpecularFactor()),t.setRoughnessFactor(1-n.getGlossinessFactor())}();return f&&f.then?f.then(r):r()});return Promise.resolve(l&&l.then?l.then(t):t())}catch(u){return Promise.reject(u)}})},exports.normals=function(e){void 0===e&&(e=Yt);const t={...Yt,...e};return l(Qt,function(e){try{const r=e.getLogger();let n=0;return Promise.resolve(e.transform(Jt())).then(function(){for(const o of e.getRoot().listMeshes())for(const s of o.listPrimitives()){const o=s.getAttribute("POSITION");let i=s.getAttribute("NORMAL");if(t.overwrite&&i)i.dispose();else if(i){r.debug(`${Qt}: Skipping primitive: NORMAL found.`);continue}i=e.createAccessor().setArray(new Float32Array(3*o.getCount())).setType("VEC3");const a=[0,0,0],c=[0,0,0],l=[0,0,0];for(let e=0;e<o.getCount();e+=3){o.getElement(e+0,a),o.getElement(e+1,c),o.getElement(e+2,l);const t=er(a,c,l);i.setElement(e+0,t),i.setElement(e+1,t),i.setElement(e+2,t)}s.setAttribute("NORMAL",i),n++}n?r.debug(`${Qt}: Complete.`):r.warn(`${Qt}: No qualifying primitives found. See debug output.`)})}catch(e){return Promise.reject(e)}})},exports.palette=function(r){void 0===r&&(r=rr);const n={...rr,...r},o=Math.max(n.blockSize,1),s=Math.max(n.min,1);return l(tr,function(r){try{const n=r.getLogger(),i=r.getRoot();return Promise.resolve(r.transform(Y({propertyTypes:[e.PropertyType.ACCESSOR],keepAttributes:!1,keepIndices:!0,keepLeaves:!0}))).then(function(){function c(){function o(){function o(){let t=1;for(const n of l){const o=n.getMaterial(),s=g.get(o),i=(v.get(s)+.5)/m*(h-y)/h,a=n.getAttribute("POSITION"),c=a.getBuffer(),l=new Float32Array(2*a.getCount()).fill(i),u=r.createAccessor().setType("VEC2").setArray(l).setBuffer(c);let f;for(const e of b)e.equals(o,A)&&(f=e);if(!f){const r=(t++).toString().padStart(3,"0");f=o.clone().setName(`PaletteMaterial${r}`),S&&f.setBaseColorFactor([1,1,1,1]).setBaseColorTexture(S).getBaseColorTextureInfo().setMinFilter(e.TextureInfo.MinFilter.NEAREST).setMagFilter(e.TextureInfo.MagFilter.NEAREST),P&&f.setEmissiveFactor([1,1,1]).setEmissiveTexture(P).getEmissiveTextureInfo().setMinFilter(e.TextureInfo.MinFilter.NEAREST).setMagFilter(e.TextureInfo.MagFilter.NEAREST),M&&f.setMetallicFactor(1).setRoughnessFactor(1).setMetallicRoughnessTexture(M).getMetallicRoughnessTextureInfo().setMinFilter(e.TextureInfo.MinFilter.NEAREST).setMagFilter(e.TextureInfo.MagFilter.NEAREST),b.push(f)}n.setMaterial(f).setAttribute("TEXCOORD_0",u)}return Promise.resolve(r.transform(Y({propertyTypes:[e.PropertyType.MATERIAL]}))).then(function(){n.debug(`${tr}: Complete.`)})}const s=function(){if(M)return Promise.resolve(t.savePixels(T.metallicRoughness,x)).then(function(e){M.setImage(e).setMimeType(x)})}();return s&&s.then?s.then(o):o()}const s=function(){if(P)return Promise.resolve(t.savePixels(T.emissive,x)).then(function(e){P.setImage(e).setMimeType(x)})}();return s&&s.then?s.then(o):o()}const l=new Set,u=new Set;for(const e of i.listMeshes())for(const t of e.listPrimitives()){const e=t.getMaterial();e&&!t.getAttribute("TEXCOORD_0")&&(l.add(t),u.add(e))}const f=new Set,g=new Map,p={baseColor:new Set,emissive:new Set,metallicRoughness:new Set};for(const e of u){const t=or(e.getBaseColorFactor().slice()),r=or([...e.getEmissiveFactor(),1]),n=nr(e.getRoughnessFactor()),o=nr(e.getMetallicFactor()),s=`baseColor:${t},emissive:${r},metallicRoughness:${o}${n}`;p.baseColor.add(t),p.emissive.add(r),p.metallicRoughness.add(o+"+"+n),f.add(s),g.set(e,s)}const m=f.size;if(m<s)return void n.debug(`${tr}: Found <${s} unique material properties. Exiting.`);const h=sr(m*o),d=sr(o),y=h-m*o,T={baseColor:null,emissive:null,metallicRoughness:null},A=new Set(["name","extras"]),E=function(){return[].slice.call(arguments).forEach(e=>A.add(e))};let S=null,P=null,M=null;if(p.baseColor.size>=s){const e="PaletteBaseColor";S=r.createTexture(e).setURI(`${e}.png`),T.baseColor=a.default(new Uint8Array(h*d*4),[h,d,4]),E("baseColorFactor","baseColorTexture","baseColorTextureInfo")}if(p.emissive.size>=s){const e="PaletteEmissive";P=r.createTexture(e).setURI(`${e}.png`),T.emissive=a.default(new Uint8Array(h*d*4),[h,d,4]),E("emissiveFactor","emissiveTexture","emissiveTextureInfo")}if(p.metallicRoughness.size>=s){const e="PaletteMetallicRoughness";M=r.createTexture(e).setURI(`${e}.png`),T.metallicRoughness=a.default(new Uint8Array(h*d*4),[h,d,4]),E("metallicFactor","roughnessFactor","metallicRoughnessTexture","metallicRoughnessTextureInfo")}if(!(S||P||M))return void n.debug(`${tr}: No material property has >=${s} unique values. Exiting.`);const I=new Set,v=new Map,b=[];let N=0;for(const t of u){const r=g.get(t);if(I.has(r))continue;const n=N++;if(T.baseColor){const r=T.baseColor,s=[...t.getBaseColorFactor()];e.ColorUtils.convertLinearToSRGB(s,s),ir(r,n,s,o)}if(T.emissive){const r=T.emissive,s=[...t.getEmissiveFactor(),1];e.ColorUtils.convertLinearToSRGB(s,s),ir(r,n,s,o)}if(T.metallicRoughness){const e=T.metallicRoughness,r=t.getMetallicFactor();ir(e,n,[0,t.getRoughnessFactor(),r,1],o)}I.add(r),v.set(r,n)}const x="image/png",R=function(){if(S)return Promise.resolve(t.savePixels(T.baseColor,x)).then(function(e){S.setImage(e).setMimeType(x)})}();return R&&R.then?R.then(c):c()})}catch(e){return Promise.reject(e)}})},exports.partition=function(t){void 0===t&&(t=cr);const r={...cr,...t};return l(ar,function(t){try{const n=t.getLogger();return!1!==r.meshes&&function(e,t,r){const n=new Set(e.getRoot().listBuffers().map(e=>e.getURI()));e.getRoot().listMeshes().forEach((o,s)=>{if(Array.isArray(r.meshes)&&!r.meshes.includes(o.getName()))return void t.debug(`${ar}: Skipping mesh #${s} with name "${o.getName()}".`);t.debug(`${ar}: Creating buffer for mesh "${o.getName()}".`);const i=e.createBuffer(o.getName()).setURI(lr(o.getName()||"mesh",n));o.listPrimitives().forEach(e=>{const t=e.getIndices();t&&t.setBuffer(i),e.listAttributes().forEach(e=>e.setBuffer(i)),e.listTargets().forEach(e=>{e.listAttributes().forEach(e=>e.setBuffer(i))})})})}(t,n,r),!1!==r.animations&&function(e,t,r){const n=new Set(e.getRoot().listBuffers().map(e=>e.getURI()));e.getRoot().listAnimations().forEach((o,s)=>{if(Array.isArray(r.animations)&&!r.animations.includes(o.getName()))return void t.debug(`${ar}: Skipping animation #${s} with name "${o.getName()}".`);t.debug(`${ar}: Creating buffer for animation "${o.getName()}".`);const i=e.createBuffer(o.getName()).setURI(lr(o.getName()||"animation",n));o.listSamplers().forEach(e=>{const t=e.getInput(),r=e.getOutput();t&&t.setBuffer(i),r&&r.setBuffer(i)})})}(t,n,r),r.meshes||r.animations||n.warn(`${ar}: Select animations or meshes to create a partition.`),Promise.resolve(t.transform(Y({propertyTypes:[e.PropertyType.BUFFER]}))).then(function(){n.debug(`${ar}: Complete.`)})}catch(e){return Promise.reject(e)}})},exports.prune=Y,exports.quantize=Rt,exports.reorder=dt,exports.resample=function(t){void 0===t&&(t=Er);const r={...Er,...t};return l(Tr,function(t,n){try{const o=new Set,s=t.getRoot().listAccessors().length,i=t.getLogger(),a=r.resample;return Promise.resolve(r.ready).then(function(){function c(){i.debug(`${Tr}: Complete.`)}for(const e of t.getRoot().listAnimations()){const t=new Map;for(const r of e.listChannels())t.set(r.getSampler(),r.getTargetPath());for(const n of e.listSamplers()){const e=n.getInterpolation();if("STEP"===e||"LINEAR"===e){const s=n.getInput(),i=n.getOutput();o.add(s),o.add(i);const c=Sr(s.getArray(),s.getComponentType(),s.getNormalized()),l=Sr(i.getArray(),i.getComponentType(),i.getNormalized()),u=l.length/c.length,f=c.length;let g;if(g="STEP"===e?a(c,l,"step",r.tolerance):"rotation"===t.get(n)?a(c,l,"slerp",r.tolerance):a(c,l,"lerp",r.tolerance),g<f){const e=s.getArray(),t=i.getArray(),r=Pr(new Float32Array(c.buffer,c.byteOffset,g),s.getComponentType(),s.getNormalized()),o=Pr(new Float32Array(l.buffer,l.byteOffset,g*u),i.getComponentType(),i.getNormalized());s.setArray(Ar),i.setArray(Ar),n.setInput(s.clone().setArray(r)),n.setOutput(i.clone().setArray(o)),s.setArray(e),i.setArray(t)}}}}for(const t of Array.from(o.values()))t.listParents().some(t=>!(t instanceof e.Root))||t.dispose();const l=t.getRoot().listAccessors().length,f=function(){if(l>s&&!u(n,Tr,"dedup"))return Promise.resolve(t.transform(B({propertyTypes:[e.PropertyType.ACCESSOR]}))).then(function(){})}();return f&&f.then?f.then(c):c()})}catch(e){return Promise.reject(e)}})},exports.sequence=function(t){void 0===t&&(t=Ir);const r={...Ir,...t};return l(Mr,t=>{const n=t.getLogger(),o=t.getRoot(),s=r.fps,i=o.listNodes().filter(e=>e.getName().match(r.pattern));r.sort&&i.sort((e,t)=>e.getName()>t.getName()?1:-1);const a=t.createAnimation(r.name),c=o.listBuffers()[0];i.forEach((r,n)=>{let o,l;0===n?(o=[n/s,(n+1)/s],l=[1,1,1,0,0,0]):n===i.length-1?(o=[(n-1)/s,n/s],l=[0,0,0,1,1,1]):(o=[(n-1)/s,n/s,(n+1)/s],l=[0,0,0,1,1,1,0,0,0]);const u=t.createAccessor().setArray(new Float32Array(o)).setBuffer(c),f=t.createAccessor().setArray(new Float32Array(l)).setBuffer(c).setType(e.Accessor.Type.VEC3),g=t.createAnimationSampler().setInterpolation(e.AnimationSampler.Interpolation.STEP).setInput(u).setOutput(f),p=t.createAnimationChannel().setTargetNode(r).setTargetPath(e.AnimationChannel.TargetPath.SCALE).setSampler(g);a.addSampler(g).addChannel(p)}),n.debug(`${Mr}: Complete.`)})},exports.simplify=function(t){const r={...br,...t},n=r.simplifier;if(!n)throw new Error(`${vr}: simplifier dependency required — install "meshoptimizer".`);return l(vr,function(t,o){try{const s=t.getLogger();return Promise.resolve(n.ready).then(function(){return Promise.resolve(t.transform(pe({overwrite:!1}))).then(function(){for(const n of t.getRoot().listMeshes()){for(const o of n.listPrimitives())o.getMode()===e.Primitive.Mode.TRIANGLES?(Nr(t,o,r),0===o.getIndices().getCount()&&o.dispose()):s.warn(`${vr}: Skipping primitive of mesh "${n.getName()}": Requires TRIANGLES draw mode.`);0===n.listPrimitives().length&&n.dispose()}return Promise.resolve(t.transform(Y({propertyTypes:[e.PropertyType.ACCESSOR,e.PropertyType.NODE],keepAttributes:!0,keepIndices:!0,keepLeaves:!1}))).then(function(){function r(){s.debug(`${vr}: Complete.`)}const n=function(){if(!u(o,vr,"dedup"))return Promise.resolve(t.transform(B({propertyTypes:[e.PropertyType.ACCESSOR]}))).then(function(){})}();return n&&n.then?n.then(r):r()})})})}catch(e){return Promise.reject(e)}})},exports.simplifyPrimitive=Nr,exports.sortPrimitiveWeights=yt,exports.sparse=function(t){void 0===t&&(t=Rr);const r={...Rr,...t}.ratio;if(r<0||r>1)throw new Error(`${xr}: Ratio must be between 0 and 1.`);return l(xr,t=>{const n=t.getRoot(),o=t.getLogger();let s=0;for(const t of n.listAccessors()){const n=t.getCount(),o=Array(t.getElementSize()).fill(0),i=Array(t.getElementSize()).fill(0);let a=0;for(let s=0;s<n&&(t.getElement(s,i),e.MathUtils.eq(i,o,0)||a++,!(a/n>=r));s++);const c=a/n<r;c!==t.getSparse()&&(t.setSparse(c),s++)}o.debug(`${xr}: Updated ${s} accessors.`),o.debug(`${xr}: Complete.`)})},exports.tangents=function(t){if(void 0===t&&(t=Wr),!t.generateTangents)throw new Error(`${Hr}: generateTangents callback required — install "mikktspace".`);const r={...Wr,...t};return l(Hr,t=>{const n=t.getLogger(),o=new Map,s=new Map;let i=0;for(const a of t.getRoot().listMeshes()){const c=a.getName(),l=a.listPrimitives();for(let a=0;a<l.length;a++){const u=l[a];if(!Kr(u,n,c,a,r.overwrite))continue;const f=Xr(u),g=u.getAttribute("POSITION").getArray(),p=u.getAttribute("NORMAL").getArray(),m=u.getAttribute(f).getArray(),h=o.get(g)||e.uuid();o.set(g,h);const d=o.get(p)||e.uuid();o.set(p,d);const y=o.get(m)||e.uuid();o.set(m,y);const T=u.getAttribute("TANGENT");T&&2===T.listParents().length&&T.dispose();const A=`${h}|${d}|${y}`;let E=s.get(A);if(E){n.debug(`${Hr}: Found cache for primitive ${a} of mesh "${c}".`),u.setAttribute("TANGENT",E),i++;continue}n.debug(`${Hr}: Generating for primitive ${a} of mesh "${c}".`);const S=u.getAttribute("POSITION").getBuffer(),P=r.generateTangents(g instanceof Float32Array?g:new Float32Array(g),p instanceof Float32Array?p:new Float32Array(p),m instanceof Float32Array?m:new Float32Array(m));for(let e=3;e<P.length;e+=4)P[e]*=-1;E=t.createAccessor().setBuffer(S).setArray(P).setType("VEC4"),u.setAttribute("TANGENT",E),s.set(A,E),i++}}i?n.debug(`${Hr}: Complete.`):n.warn(`${Hr}: No qualifying primitives found. See debug output.`)})},exports.textureCompress=function(t){const n={...qr,...t},o=n.targetFormat,s=n.pattern,i=n.formats,a=n.slots;return l(_r,function(t){try{const c=t.getLogger(),l=t.getRoot().listTextures();return Promise.resolve(Promise.all(l.map(function(r,l){try{const u=K(r),f=pt(r),g=r.getURI()||r.getName()||`${l+1}/${t.getRoot().listTextures().length}`,m=`${_r}(${g})`;if(!Gr.includes(r.getMimeType()))return c.debug(`${m}: Skipping, unsupported texture type "${r.getMimeType()}".`),Promise.resolve();if(s&&!s.test(r.getName())&&!s.test(r.getURI()))return c.debug(`${m}: Skipping, excluded by "pattern" parameter.`),Promise.resolve();if(i&&!i.test(r.getMimeType()))return c.debug(`${m}: Skipping, "${r.getMimeType()}" excluded by "formats" parameter.`),Promise.resolve();if(a&&u.length&&!u.some(e=>a.test(e)))return c.debug(`${m}: Skipping, [${u.join(", ")}] excluded by "slots" parameter.`),Promise.resolve();if("jpeg"===n.targetFormat&&f&e.TextureChannel.A)return c.warn(`${m}: Skipping, [${u.join(", ")}] requires alpha channel.`),Promise.resolve();const h=Br(r);c.debug(`${m}: Format = ${h} → ${o||h}`),c.debug(`${m}: Slots = [${u.join(", ")}]`);const d=r.getImage(),y=d.byteLength;return Promise.resolve(Ur(r,n)).then(function(){const e=r.getImage(),t=e.byteLength,n=d===e?" (SKIPPED":"";c.debug(`${m}: Size = ${p(y)} → ${p(t)}${n}`)})}catch(e){return Promise.reject(e)}}))).then(function(){const e=t.createExtension(r.EXTTextureWebP);l.some(e=>"image/webp"===e.getMimeType())?e.setRequired(!0):e.dispose();const n=t.createExtension(r.EXTTextureAVIF);l.some(e=>"image/avif"===e.getMimeType())?n.setRequired(!0):n.dispose(),c.debug(`${_r}: Complete.`)})}catch(e){return Promise.reject(e)}})},exports.textureResize=function(r){void 0===r&&(r=Fr);const n={...Fr,...r};return l(Lr,function(r){try{let i;function o(e){c.debug(`${Lr}: Complete.`)}const c=r.getLogger(),l=function(e,t,r){if("function"==typeof e[Cr]){var n,o,s,i=e[Cr]();if(function e(a){try{for(;!((n=i.next()).done||r&&r());)if((a=t(n.value))&&a.then){if(!$r(a))return void a.then(e,s||(s=wr.bind(null,o=new Or,2)));a=a.v}o?wr(o,1,a):o=a}catch(e){wr(o||(o=new Or),2,e)}}(),i.return){var a=function(e){try{n.done||i.return()}catch(e){}return e};if(o&&o.then)return o.then(a,function(e){throw a(e)});a()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var c=[],l=0;l<e.length;l++)c.push(e[l]);return function(e,t,r){var n,o,s=-1;return function i(a){try{for(;++s<e.length&&(!r||!r());)if((a=t(s))&&a.then){if(!$r(a))return void a.then(i,o||(o=wr.bind(null,n=new Or,2)));a=a.v}n?wr(n,1,a):n=a}catch(e){wr(n||(n=new Or),2,e)}}(),n}(c,function(e){return t(c[e])},r)}(r.getRoot().listTextures(),function(r){const o=r.getName(),i=r.getURI();if(n.pattern&&!n.pattern.test(o)&&!n.pattern.test(i))return void c.debug(`${Lr}: Skipping, excluded by "pattern" parameter.`);if("image/png"!==r.getMimeType()&&"image/jpeg"!==r.getMimeType())return void c.warn(`${Lr}: Skipping, unsupported texture type "${r.getMimeType()}".`);const l=K(r);if(n.slots&&!l.some(e=>{var t;return null==(t=n.slots)?void 0:t.test(e)}))return void c.debug(`${Lr}: Skipping, [${l.join(", ")}] excluded by "slots" parameter.`);const u=r.getSize(),f=P(u,n.size);if(e.MathUtils.eq(u,f))return void c.debug(`${Lr}: Skipping, not within size range.`);const g=r.getImage();return Promise.resolve(t.getPixels(g,r.getMimeType())).then(function(e){const u=a.default(new Uint8Array(f[0]*f[1]*4),[...f,4]);c.debug(`${Lr}: Resizing "${i||o}", ${e.shape} → ${u.shape}...`),c.debug(`${Lr}: Slots → [${l.join(", ")}]`);try{n.filter===exports.TextureResizeFilter.LANCZOS3?s.lanczos3(e,u):s.lanczos2(e,u)}catch(e){if(e instanceof Error)return void c.warn(`${Lr}: Failed to resize "${i||o}": "${e.message}".`);throw e}const g=r.setImage;return Promise.resolve(t.savePixels(u,r.getMimeType())).then(function(e){g.call(r,e)})})},function(){return i});return Promise.resolve(l&&l.then?l.then(o):o())}catch(u){return Promise.reject(u)}})},exports.transformMesh=Re,exports.transformPrimitive=ve,exports.unlit=function(){return e=>{const t=e.createExtension(r.KHRMaterialsUnlit).createUnlit();e.getRoot().listMaterials().forEach(e=>{e.setExtension("KHR_materials_unlit",t)})}},exports.unpartition=function(e){return l(Vr,function(e){try{const t=e.getLogger(),r=e.getRoot().listBuffers()[0];return e.getRoot().listAccessors().forEach(e=>e.setBuffer(r)),e.getRoot().listBuffers().forEach((e,t)=>t>0?e.dispose():null),t.debug(`${Vr}: Complete.`),Promise.resolve()}catch(e){return Promise.reject(e)}})},exports.unweld=Jt,exports.vertexColorSpace=Qr,exports.weld=pe,exports.weldPrimitive=me;
//# sourceMappingURL=functions.cjs.map
