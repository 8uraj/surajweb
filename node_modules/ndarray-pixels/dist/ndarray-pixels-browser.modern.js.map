{"version":3,"file":"ndarray-pixels-browser.modern.js","sources":["../src/browser-get-pixels.ts","../src/common.ts","../src/browser-save-pixels.ts","../src/index.ts"],"sourcesContent":["import ndarray from 'ndarray';\nimport type { NdArray } from 'ndarray';\n\nexport function getPixelsInternal(\n\tbuffer: Uint8Array,\n\tmimeType: string\n): Promise<NdArray<Uint8Array>> {\n\t// Warn for Data URIs, URLs, and file paths. Support removed in v3.\n\tif (!(buffer instanceof Uint8Array)) {\n\t\tthrow new Error('[ndarray-pixels] Input must be Uint8Array or Buffer.');\n\t}\n\n\tconst blob = new Blob([buffer], { type: mimeType });\n\tconst path = URL.createObjectURL(blob);\n\n\t// Decode image with Canvas API.\n\treturn new Promise((resolve, reject) => {\n\t\tconst img = new Image();\n\t\timg.crossOrigin = 'anonymous';\n\t\timg.onload = function () {\n\t\t\tURL.revokeObjectURL(path as string);\n\n\t\t\tconst canvas = document.createElement('canvas');\n\t\t\tcanvas.width = img.width;\n\t\t\tcanvas.height = img.height;\n\t\t\tconst context = canvas.getContext('2d')!;\n\t\t\tcontext.drawImage(img, 0, 0);\n\t\t\tconst pixels = context.getImageData(0, 0, img.width, img.height);\n\t\t\tresolve(\n\t\t\t\tndarray(\n\t\t\t\t\tnew Uint8Array(pixels.data),\n\t\t\t\t\t[img.width, img.height, 4],\n\t\t\t\t\t[4, 4 * img.width, 1],\n\t\t\t\t\t0\n\t\t\t\t)\n\t\t\t);\n\t\t};\n\t\timg.onerror = (err) => {\n\t\t\tURL.revokeObjectURL(path as string);\n\t\t\treject(err);\n\t\t};\n\t\timg.src = path;\n\t});\n}\n","import ndarray, { NdArray } from 'ndarray';\nimport ops from 'ndarray-ops';\n\nexport function putPixelData(\n\tarray: NdArray<Uint8Array | Uint8ClampedArray>,\n\tdata: Uint8Array | Uint8ClampedArray,\n\tframe = -1\n): Uint8Array | Uint8ClampedArray {\n\tif (array.shape.length === 4) {\n\t\treturn putPixelData(array.pick(frame), data, 0);\n\t} else if (array.shape.length === 3) {\n\t\tif (array.shape[2] === 3) {\n\t\t\tops.assign(\n\t\t\t\tndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]),\n\t\t\t\tarray\n\t\t\t);\n\t\t\tops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n\t\t} else if (array.shape[2] === 4) {\n\t\t\tops.assign(\n\t\t\t\tndarray(data, [array.shape[0], array.shape[1], 4], [4, array.shape[0] * 4, 1]),\n\t\t\t\tarray\n\t\t\t);\n\t\t} else if (array.shape[2] === 1) {\n\t\t\tops.assign(\n\t\t\t\tndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]),\n\t\t\t\tndarray(\n\t\t\t\t\tarray.data,\n\t\t\t\t\t[array.shape[0], array.shape[1], 3],\n\t\t\t\t\t[array.stride[0], array.stride[1], 0],\n\t\t\t\t\tarray.offset\n\t\t\t\t)\n\t\t\t);\n\t\t\tops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n\t\t} else {\n\t\t\tthrow new Error('[ndarray-pixels] Incompatible array shape.');\n\t\t}\n\t} else if (array.shape.length === 2) {\n\t\tops.assign(\n\t\t\tndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]),\n\t\t\tndarray(\n\t\t\t\tarray.data,\n\t\t\t\t[array.shape[0], array.shape[1], 3],\n\t\t\t\t[array.stride[0], array.stride[1], 0],\n\t\t\t\tarray.offset\n\t\t\t)\n\t\t);\n\t\tops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n\t} else {\n\t\tthrow new Error('[ndarray-pixels] Incompatible array shape.');\n\t}\n\treturn data;\n}\n","import type { NdArray } from 'ndarray';\nimport { putPixelData } from './common';\n\nexport interface EncoderOptions {\n\tquality?: number;\n}\n\nexport async function savePixelsInternal(\n\tpixels: NdArray<Uint8Array | Uint8ClampedArray>,\n\tmimeType: string\n): Promise<Uint8Array>;\nexport async function savePixelsInternal(\n\tpixels: NdArray<Uint8Array | Uint8ClampedArray>,\n\tmimeType: string,\n\toptions?: EncoderOptions\n): Promise<Uint8Array>;\nexport async function savePixelsInternal(\n\tpixels: NdArray<Uint8Array | Uint8ClampedArray>,\n\tmimeType: string,\n\toptions: EncoderOptions = {}\n): Promise<Uint8Array> {\n\t// Create HTMLCanvasElement and write pixel data.\n\tconst canvas = document.createElement('canvas');\n\tcanvas.width = pixels.shape[0];\n\tcanvas.height = pixels.shape[1];\n\n\tconst context = canvas.getContext('2d')!;\n\tconst imageData = context.getImageData(0, 0, canvas.width, canvas.height);\n\n\tputPixelData(pixels, imageData.data);\n\tcontext.putImageData(imageData, 0, 0);\n\n\tconst quality = options.quality ? options.quality / 100 : undefined;\n\n\t// Encode to target format.\n\tswitch (mimeType) {\n\t\tcase 'image/jpeg':\n\t\t\treturn streamCanvas(canvas, 'image/jpeg', quality);\n\t\tdefault:\n\t\t\treturn streamCanvas(canvas, mimeType);\n\t}\n}\n\n/** Creates readable stream from given HTMLCanvasElement and options. */\nfunction streamCanvas(\n\tcanvas: HTMLCanvasElement,\n\tmimeType: string,\n\tquality?: number\n): Promise<Uint8Array> {\n\treturn new Promise<Uint8Array>((resolve, reject) => {\n\t\tcanvas.toBlob(\n\t\t\tasync (blob) => {\n\t\t\t\tif (blob) {\n\t\t\t\t\tresolve(new Uint8Array(await blob.arrayBuffer()));\n\t\t\t\t} else {\n\t\t\t\t\treject(new Error('[ndarray-pixels] Failed to canvas.toBlob().'));\n\t\t\t\t}\n\t\t\t},\n\t\t\tmimeType,\n\t\t\tquality\n\t\t);\n\t});\n}\n","import type { NdArray } from 'ndarray';\nimport { getPixelsInternal } from './node-get-pixels';\nimport { savePixelsInternal } from './node-save-pixels';\n\n/**\n * Decodes image data to an `ndarray`.\n *\n * MIME type is optional when given a path or URL, and required when given a Uint8Array.\n *\n * Accepts `image/png` or `image/jpeg` in Node.js, and additional formats on browsers with\n * the necessary support in Canvas 2D.\n *\n * @param data\n * @param mimeType `image/jpeg`, `image/png`, etc.\n * @returns\n */\nasync function getPixels(data: Uint8Array, mimeType: string): Promise<NdArray<Uint8Array>> {\n\treturn getPixelsInternal(data, mimeType);\n}\n\n/**\n * Encodes an `ndarray` as image data in the given format.\n *\n * If the source `ndarray` was constructed manually with default stride, use\n * `ndarray.transpose(1, 0)` to reshape it and ensure an identical result from getPixels(). For an\n * ndarray created by getPixels(), this isn't necessary.\n *\n * Accepts `image/png` or `image/jpeg` in Node.js, and additional formats on browsers with\n * the necessary support in Canvas 2D.\n *\n * @param pixels ndarray of shape W x H x 4.\n * @param mimeType `image/jpeg`, `image/png`, etc.\n * @returns\n */\nasync function savePixels(\n\tpixels: NdArray<Uint8Array | Uint8ClampedArray>,\n\tmimeType: string\n): Promise<Uint8Array> {\n\treturn savePixelsInternal(pixels, mimeType);\n}\n\nexport { getPixels, savePixels };\n"],"names":["getPixelsInternal","buffer","mimeType","Uint8Array","Error","blob","Blob","type","path","URL","createObjectURL","Promise","resolve","reject","img","Image","crossOrigin","onload","revokeObjectURL","canvas","document","createElement","width","height","context","getContext","drawImage","pixels","getImageData","ndarray","data","onerror","err","src","putPixelData","array","frame","shape","length","pick","ops","assign","assigns","stride","offset","savePixelsInternal","options","imageData","putImageData","quality","undefined","streamCanvas","toBlob","arrayBuffer","getPixels","savePixels"],"mappings":"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"}