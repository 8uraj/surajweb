{"version":3,"file":"ndarray-pixels-node.cjs","sources":["../src/node-get-pixels.ts","../src/common.ts","../src/node-save-pixels.ts","../src/index.ts"],"sourcesContent":["import ndarray, { NdArray } from 'ndarray';\nimport sharp from 'sharp';\n\nexport async function getPixelsInternal(\n\tbuffer: Uint8Array,\n\t_mimeType: string\n): Promise<NdArray<Uint8Array>> {\n\t// Warn for Data URIs, URLs, and file paths. Support removed in v3.\n\tif (!(buffer instanceof Uint8Array)) {\n\t\tthrow new Error('[ndarray-pixels] Input must be Uint8Array or Buffer.');\n\t}\n\n\tconst { data, info } = await sharp(buffer)\n\t\t.ensureAlpha()\n\t\t.raw()\n\t\t.toBuffer({ resolveWithObject: true });\n\n\treturn ndarray(\n\t\tnew Uint8Array(data),\n\t\t[info.width, info.height, 4],\n\t\t[4, (4 * info.width) | 0, 1],\n\t\t0\n\t);\n}\n","import ndarray, { NdArray } from 'ndarray';\nimport ops from 'ndarray-ops';\n\nexport function putPixelData(\n\tarray: NdArray<Uint8Array | Uint8ClampedArray>,\n\tdata: Uint8Array | Uint8ClampedArray,\n\tframe = -1\n): Uint8Array | Uint8ClampedArray {\n\tif (array.shape.length === 4) {\n\t\treturn putPixelData(array.pick(frame), data, 0);\n\t} else if (array.shape.length === 3) {\n\t\tif (array.shape[2] === 3) {\n\t\t\tops.assign(\n\t\t\t\tndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]),\n\t\t\t\tarray\n\t\t\t);\n\t\t\tops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n\t\t} else if (array.shape[2] === 4) {\n\t\t\tops.assign(\n\t\t\t\tndarray(data, [array.shape[0], array.shape[1], 4], [4, array.shape[0] * 4, 1]),\n\t\t\t\tarray\n\t\t\t);\n\t\t} else if (array.shape[2] === 1) {\n\t\t\tops.assign(\n\t\t\t\tndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]),\n\t\t\t\tndarray(\n\t\t\t\t\tarray.data,\n\t\t\t\t\t[array.shape[0], array.shape[1], 3],\n\t\t\t\t\t[array.stride[0], array.stride[1], 0],\n\t\t\t\t\tarray.offset\n\t\t\t\t)\n\t\t\t);\n\t\t\tops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n\t\t} else {\n\t\t\tthrow new Error('[ndarray-pixels] Incompatible array shape.');\n\t\t}\n\t} else if (array.shape.length === 2) {\n\t\tops.assign(\n\t\t\tndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]),\n\t\t\tndarray(\n\t\t\t\tarray.data,\n\t\t\t\t[array.shape[0], array.shape[1], 3],\n\t\t\t\t[array.stride[0], array.stride[1], 0],\n\t\t\t\tarray.offset\n\t\t\t)\n\t\t);\n\t\tops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n\t} else {\n\t\tthrow new Error('[ndarray-pixels] Incompatible array shape.');\n\t}\n\treturn data;\n}\n","import { NdArray } from 'ndarray';\nimport sharp, { AvailableFormatInfo } from 'sharp';\nimport { putPixelData } from './common';\n\nexport async function savePixelsInternal(\n\tpixels: NdArray<Uint8Array | Uint8ClampedArray>,\n\tmimeType: string\n): Promise<Uint8Array> {\n\tconst [width, height, channels] = pixels.shape as [number, number, 4];\n\tconst data = putPixelData(pixels, new Uint8Array(width * height * channels));\n\tconst format = mimeType.replace('image/', '') as unknown as AvailableFormatInfo;\n\treturn sharp(data, { raw: { width, height, channels } }).toFormat(format).toBuffer();\n}\n","import type { NdArray } from 'ndarray';\nimport { getPixelsInternal } from './node-get-pixels';\nimport { savePixelsInternal } from './node-save-pixels';\n\n/**\n * Decodes image data to an `ndarray`.\n *\n * MIME type is optional when given a path or URL, and required when given a Uint8Array.\n *\n * Accepts `image/png` or `image/jpeg` in Node.js, and additional formats on browsers with\n * the necessary support in Canvas 2D.\n *\n * @param data\n * @param mimeType `image/jpeg`, `image/png`, etc.\n * @returns\n */\nasync function getPixels(data: Uint8Array, mimeType: string): Promise<NdArray<Uint8Array>> {\n\treturn getPixelsInternal(data, mimeType);\n}\n\n/**\n * Encodes an `ndarray` as image data in the given format.\n *\n * If the source `ndarray` was constructed manually with default stride, use\n * `ndarray.transpose(1, 0)` to reshape it and ensure an identical result from getPixels(). For an\n * ndarray created by getPixels(), this isn't necessary.\n *\n * Accepts `image/png` or `image/jpeg` in Node.js, and additional formats on browsers with\n * the necessary support in Canvas 2D.\n *\n * @param pixels ndarray of shape W x H x 4.\n * @param mimeType `image/jpeg`, `image/png`, etc.\n * @returns\n */\nasync function savePixels(\n\tpixels: NdArray<Uint8Array | Uint8ClampedArray>,\n\tmimeType: string\n): Promise<Uint8Array> {\n\treturn savePixelsInternal(pixels, mimeType);\n}\n\nexport { getPixels, savePixels };\n"],"names":["getPixelsInternal","buffer","_mimeType","Uint8Array","Error","data","info","sharp","ensureAlpha","raw","toBuffer","resolveWithObject","ndarray","width","height","putPixelData","array","frame","shape","length","pick","ops","assign","assigns","stride","offset","savePixelsInternal","pixels","mimeType","channels","format","replace","toFormat","getPixels","savePixels"],"mappings":"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"}